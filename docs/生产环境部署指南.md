# zMessage 生产环境部署指南

## 1. 服务器环境准备

### 1.1 系统要求

| 项目 | 要求 |
|------|------|
| 操作系统 | Ubuntu 20.04+ / Debian 11+ |
| CPU | 1核心+ |
| 内存 | 512MB+ |
| 磁盘 | 10GB+ (含数据和日志) |
| 网络 | 公网IP，开放80/443端口 |

### 1.2 基础软件安装

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装必要工具
sudo apt install -y curl wget git nginx certbot python3-certbot-nginx

# 安装 Go 1.24 (构建用，生产环境仅需编译后的二进制)
wget https://go.dev/dl/go1.24.0.linux-amd64.tar.gz
sudo rm -rf /usr/local/go
sudo tar -C /usr/local -xzf go1.24.0.linux-amd64.tar.gz
echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
source ~/.bashrc
go version
```

### 1.3 创建部署用户

```bash
# 创建专用用户（安全最佳实践）
sudo useradd -r -s /bin/false -m -d /var/lib/zmessage zmessage
sudo mkdir -p /var/lib/zmessage
sudo chown -R zmessage:zmessage /var/lib/zmessage
```

## 2. 应用构建

### 2.1 在本地或构建服务器构建

```bash
# 克隆项目
git clone <your-repo> /tmp/zmessage
cd /tmp/zmessage

# 下载依赖
go mod download
go mod verify

# 编译生产版本 (静态链接，无CGO依赖)
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
    -ldflags="-s -w -X main.Version=$(git describe --tags --always)" \
    -o zmessage-server server/main.go

# 验证二进制
ldd zmessage-server  # 应显示 "not a dynamic executable"
./zmessage-server -h
```

### 2.2 部署到生产服务器

```bash
# 创建目录结构
sudo mkdir -p /opt/zmessage/{bin,data,logs}
sudo mkdir -p /opt/zmessage/data/media/{original,thumbnail}

# 复制文件
sudo cp zmessage-server /opt/zmessage/bin/
sudo cp -r client /opt/zmessage/
sudo chmod +x /opt/zmessage/bin/zmessage-server

# 设置权限
sudo chown -R zmessage:zmessage /opt/zmessage
sudo chmod -R 750 /opt/zmessage
```

## 3. Systemd 服务配置

### 3.1 创建服务文件

创建 `/etc/systemd/system/zmessage.service`:

```ini
[Unit]
Description=zMessage IM Server
Documentation=https://github.com/your-repo/zmessage
After=network.target
Wants=network-online.target

[Service]
Type=simple
User=zmessage
Group=zmessage
WorkingDirectory=/opt/zmessage

# 环境变量
Environment="GIN_MODE=release"
Environment="DATA_DIR=/opt/zmessage/data"
Environment="LISTEN_ADDR=127.0.0.1:9405"

# 启动命令
ExecStart=/opt/zmessage/bin/zmessage-server \
    /opt/zmessage/data \
    127.0.0.1:9405

# 重启策略
Restart=always
RestartSec=10s

# 资源限制
LimitNOFILE=65536
LimitNPROC=4096

# 安全加固
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/zmessage/data

# 日志
StandardOutput=append:/opt/zmessage/logs/app.log
StandardError=append:/opt/zmessage/logs/error.log
SyslogIdentifier=zmessage

[Install]
WantedBy=multi-user.target
```

### 3.2 启动服务

```bash
# 重载systemd配置
sudo systemctl daemon-reload

# 启用开机自启
sudo systemctl enable zmessage

# 启动服务
sudo systemctl start zmessage

# 检查状态
sudo systemctl status zmessage

# 查看日志
sudo journalctl -u zmessage -f
```

## 4. Nginx 反向代理 + HTTPS

### 4.1 Nginx 配置

创建 `/etc/nginx/sites-available/zmessage`:

```nginx
# HTTP 重定向到 HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name lanser.fun;

    # Let's Encrypt 验证路径
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS 主配置
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name lanser.fun;

    # SSL 证书 (由 Certbot 自动配置)
    ssl_certificate /etc/letsencrypt/live/lanser.fun/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/lanser.fun/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/lanser.fun/chain.pem;

    # SSL 安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # 安全头
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # 日志
    access_log /var/log/nginx/zmessage-access.log;
    error_log /var/log/nginx/zmessage-error.log;

    # 客户端上传限制
    client_max_body_size 50M;
    client_body_buffer_size 1M;

    # 静态资源直接服务 (性能优化)
    location /assets/ {
        alias /opt/zmessage/client/assets/;
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    location /favicon.ico {
        alias /opt/zmessage/client/favicon.ico;
        expires 30d;
    }

    # SSE (Server-Sent Events) 代理 - 主要消息推送方式
    location /api/sse/subscribe {
        proxy_pass http://127.0.0.1:9405;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SSE 禁止缓冲
        proxy_buffering off;
        proxy_cache off;

        # SSE 超时配置（保持长连接）
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }

    # WebSocket 代理（备用）
    location /ws {
        proxy_pass http://127.0.0.1:9405;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 超时配置
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }

    # API 代理
    location / {
        proxy_pass http://127.0.0.1:9405;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

### 4.2 启用配置并获取证书

```bash
# 启用站点
sudo ln -s /etc/nginx/sites-available/zmessage /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 先启动 HTTP 服务（Let's Encrypt 需要验证）
sudo systemctl reload nginx

# 获取 SSL 证书 (使用 HTTP-01 验证)
sudo certbot --nginx -d lanser.fun --email your@email.com --agree-tos --no-eff-email

# 设置自动续期
sudo systemctl status certbot.timer
sudo certbot renew --dry-run

# 重新加载 Nginx
sudo systemctl reload nginx
```

### 4.3 子路径部署方案

如果已有域名 `lanser.fun`，想要将 zMessage 部署到 `/zmessage` 路径下，访问地址为 `https://lanser.fun/zmessage/`，则无需修改后端代码，只需在 Nginx 配置中添加子路径代理。

在现有的 `/etc/nginx/sites-available/lanser.fun` 配置文件中添加：

```nginx
# 在现有的 server block 中添加以下 location

# 静态资源
location /zmessage/assets/ {
    alias /opt/zmessage/client/assets/;
    expires 7d;
    add_header Cache-Control "public, immutable";
}

# 前端入口 - 需要处理 SPA 路由
location /zmessage/ {
    # 重写路径，去除 /zmessage 前缀
    rewrite ^/zmessage/(.*)$ /$1 break;

    proxy_pass http://127.0.0.1:9405;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # 超时配置
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}

# API 代理
location /zmessage/api/ {
    # 重写路径，去除 /zmessage 前缀
    rewrite ^/zmessage/(.*)$ /$1 break;

    proxy_pass http://127.0.0.1:9405;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # 超时配置
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}

# SSE (Server-Sent Events) 代理
location /zmessage/api/sse/subscribe {
    # 重写路径，去除 /zmessage 前缀
    rewrite ^/zmessage/(.*)$ /$1 break;

    proxy_pass http://127.0.0.1:9405;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # SSE 禁止缓冲
    proxy_buffering off;
    proxy_cache off;

    # SSE 超时配置（保持长连接）
    proxy_connect_timeout 7d;
    proxy_send_timeout 7d;
    proxy_read_timeout 7d;
}

# WebSocket 代理（备用）
location /zmessage/ws {
    # 重写路径，去除 /zmessage 前缀
    rewrite ^/zmessage/(.*)$ /$1 break;

    proxy_pass http://127.0.0.1:9405;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket 超时配置
    proxy_connect_timeout 7d;
    proxy_send_timeout 7d;
    proxy_read_timeout 7d;
}
```

**重要说明**：
1. 后端服务无需任何修改，监听 `127.0.0.1:9405`
2. 所有路径重写由 Nginx 完成
3. 前端无需配置 base path，API 调用使用相对路径即可
4. 语音录制功能仍然需要 HTTPS（`https://lanser.fun/zmessage/`）

### 4.4 HTTPS 重要说明

**语音录制功能必须使用 HTTPS**

浏览器的 `getUserMedia` API（用于录音）要求安全上下文：
- **必须**使用 HTTPS 访问
- 例外：`localhost`、`127.0.0.1` 等本地地址无需 HTTPS

如果用户通过 HTTP 访问，录音功能将不可用，前端会显示"录音需要HTTPS连接"的错误提示。

## 5. 防火墙配置

```bash
# UFW 防火墙
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS

# 启用防火墙
sudo ufw enable
sudo ufw status
```

## 6. 数据备份策略

### 6.1 创建备份脚本

创建 `/opt/zmessage/scripts/backup.sh`:

```bash
#!/bin/bash
set -e

BACKUP_DIR="/opt/zmessage/data/backups"
DATA_DIR="/opt/zmessage/data"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

# 创建备份目录
mkdir -p "$BACKUP_DIR"

# 备份数据库
sqlite3 "$DATA_DIR/messages.db" ".backup \"$BACKUP_DIR/messages_$DATE.db\""

# 备份上传的媒体文件
tar -czf "$BACKUP_DIR/media_$DATE.tar.gz" -C "$DATA_DIR" media 2>/dev/null || true

# 清理旧备份
find "$BACKUP_DIR" -name "*.db" -mtime +$RETENTION_DAYS -delete
find "$BACKUP_DIR" -name "*.tar.gz" -mtime +$RETENTION_DAYS -delete

echo "Backup completed: $DATE"
ls -lh "$BACKUP_DIR"
```

### 6.2 配置定时任务

```bash
# 编辑 crontab
sudo crontab -e -u zmessage

# 添加以下行（每天凌晨2点备份）
0 2 * * * /opt/zmessage/scripts/backup.sh >> /opt/zmessage/logs/backup.log 2>&1
```

## 7. 监控和日志

### 7.1 日志轮转

创建 `/etc/logrotate.d/zmessage`:

```
/opt/zmessage/logs/*.log {
    daily
    rotate 14
    compress
    delaycompress
    missingok
    notifempty
    create 0640 zmessage zmessage
    sharedscripts
    postrotate
        systemctl reload zmessage > /dev/null 2>&1 || true
    endscript
}
```

### 7.2 健康检查脚本

创建 `/opt/zmessage/scripts/healthcheck.sh`:

```bash
#!/bin/bash
set -e

# 检查服务状态
if ! systemctl is-active --quiet zmessage; then
    echo "ERROR: zmessage service is not running"
    exit 1
fi

# 检查端口监听
if ! ss -ln | grep -q ":9405"; then
    echo "ERROR: zmessage is not listening on port 9405"
    exit 1
fi

# 检查 API 响应
if ! curl -sf http://127.0.0.1:9405/ > /dev/null; then
    echo "ERROR: health check endpoint failed"
    exit 1
fi

echo "OK: All checks passed"
exit 0
```

## 8. 更新部署流程

### 8.1 滚动更新（零停机）

```bash
#!/bin/bash
# deploy.sh - 滚动更新脚本

VERSION=$1
if [ -z "$VERSION" ]; then
    echo "Usage: ./deploy.sh <version>"
    exit 1
fi

echo "Deploying version $VERSION..."

# 1. 下载新版本
wget -O /tmp/zmessage-server-$VERSION "https://releases.example.com/zmessage/$VERSION/zmessage-server-linux-amd64"

# 2. 验证
chmod +x /tmp/zmessage-server-$VERSION
/tmp/zmessage-server-$VERSION -v

# 3. 停止服务
sudo systemctl stop zmessage

# 4. 备份当前版本
sudo cp /opt/zmessage/bin/zmessage-server /opt/zmessage/bin/zmessage-server.backup

# 5. 安装新版本
sudo mv /tmp/zmessage-server-$VERSION /opt/zmessage/bin/zmessage-server

# 6. 启动服务
sudo systemctl start zmessage

# 7. 验证
sleep 5
sudo systemctl status zmessage
```

## 9. 安全加固

### 9.1 fail2ban 防护

```bash
# 安装 fail2ban
sudo apt install fail2ban

# 创建 jail 配置
sudo tee /etc/fail2ban/jail.local > /dev/null << 'EOF'
[zmessage]
enabled = true
port = http,https
filter = zmessage
logpath = /var/log/nginx/zmessage-access.log
maxretry = 10
findtime = 600
bantime = 3600
EOF

# 创建过滤器
sudo tee /etc/fail2ban/filter.d/zmessage.conf > /dev/null << 'EOF'
[Definition]
failregex = <HOST> .* "(GET|POST) .*" 401
ignoreregex =
EOF

# 启动
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

### 9.2 系统安全

```bash
# 禁用密码登录 SSH（使用密钥）
sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
sudo systemctl restart sshd

# 安装自动安全更新
sudo apt install unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades
```

## 10. 故障排查

### 10.1 常用命令

```bash
# 服务状态
sudo systemctl status zmessage

# 查看实时日志
sudo journalctl -u zmessage -f

# 查看最近100条日志
sudo journalctl -u zmessage -n 100

# 检查端口
sudo ss -tlnp | grep 9405

# 检查进程
ps aux | grep zmessage

# Nginx 配置测试
sudo nginx -t

# Nginx 重载
sudo systemctl reload nginx

# 查看证书有效期
sudo certbot certificates
```

### 10.2 常见问题

**问题：SSE 连接频繁断开**
```bash
# 检查 Nginx SSE 代理配置中的缓冲设置
# 确保 proxy_buffering off; 已配置
sudo nginx -t && sudo systemctl reload nginx
```

**问题：语音录制不可用**
```bash
# 确认使用 HTTPS 访问（非 localhost 需要 HTTPS）
curl -I https://lanser.fun | grep -i "strict-transport-security"

# 检查证书是否有效
sudo certbot certificates
```

**问题：WebSocket 连接失败**
```bash
# 检查 Nginx 配置中 WebSocket 代理设置
# 确保 proxy_set_header Upgrade 正确配置
sudo nginx -t && sudo systemctl reload nginx
```

**问题：服务启动失败**
```bash
# 查看详细错误
sudo journalctl -u zmessage -n 50 --no-pager

# 检查权限
sudo ls -la /opt/zmessage/
```

**问题：证书续期失败**
```bash
# 手动续期测试
sudo certbot renew --dry-run

# 检查续期日志
sudo journalctl -u certbot.timer -n 50
```

## 11. 部署检查清单

- [ ] 服务器环境已准备（Go, Nginx, Certbot）
- [ ] 应用已构建并部署
- [ ] Systemd 服务已配置并启动
- [ ] Nginx 反向代理已配置（包含 SSE 和 WebSocket）
- [ ] SSL 证书已获取并验证
- [ ] HTTPS 正常访问（语音功能必需）
- [ ] 防火墙规则已设置
- [ ] 数据备份脚本已配置
- [ ] 日志轮转已配置
- [ ] 健康检查脚本已配置
- [ ] fail2ban 已启用
- [ ] SSE 连接正常（主要消息推送）
- [ ] API 接口正常响应
