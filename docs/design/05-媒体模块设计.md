# 媒体模块设计

## 1. 模块概述

### 1.1 职责
- 文件上传处理
- 文件下载服务
- 缩略图生成
- 文件存储管理
- 文件类型验证

### 1.2 依赖
- 数据访问层 (DAL)
- 文件系统

### 1.3 被依赖
- 消息模块
- 用户模块 (头像)

## 2. 对外接口

### 2.1 HTTP API

#### POST /api/media/upload
上传媒体文件

**请求头:**
```
Authorization: Bearer <token>
Content-Type: multipart/form-data
```

**请求体:**
```
file: <binary data>
type: "image" | "voice"
```

**文件限制:**
| 类型 | 最大大小 | 允许格式 |
|------|----------|----------|
| image | 5MB | jpg, jpeg, png, gif, webp |
| voice | 10MB | mp3, m4a, ogg, wav |

**响应 (200):**
```json
{
  "id": 42,
  "type": "image",
  "original_url": "/api/media/42",
  "thumbnail_url": "/api/media/42/thumb",
  "size": 1024000,
  "mime_type": "image/jpeg",
  "width": 1920,
  "height": 1080,
  "duration": null,
  "created_at": 1707600000
}
```

**错误响应:**
- 400: 参数错误, 文件类型不支持
- 401: 未认证
- 413: 文件过大

---

#### GET /api/media/:id
获取媒体文件

**请求头:**
```
Authorization: Bearer <token> (可选, 公开访问返回头像等)
```

**响应 (200):**
```
Content-Type: <mime_type>
Content-Length: <size>

<binary data>
```

**错误响应:**
- 404: 文件不存在

---

#### GET /api/media/:id/thumb
获取缩略图 (仅图片)

**请求头:**
```
Authorization: Bearer <token> (可选)
```

**响应 (200):**
```
Content-Type: image/jpeg
Content-Length: <size>

<thumbnail binary data>
```

**错误响应:**
- 404: 文件不存在或不支持缩略图

---

#### DELETE /api/media/:id
删除媒体文件

**请求头:**
```
Authorization: Bearer <token>
```

**响应 (200):**
```json
{
  "success": true
}
```

**错误响应:**
- 401: 未认证
- 403: 无权删除
- 404: 文件不存在

---

### 2.2 内部接口 (Go)

```go
package media

// Media 媒体实体
type Media struct {
    ID             int64  `json:"id"`
    OwnerID        int64  `json:"owner_id"`
    Type           string `json:"type"`            // image/voice
    OriginalPath   string `json:"-"`
    ThumbnailPath  string `json:"-"`
    Size           int64  `json:"size"`
    MimeType       string `json:"mime_type"`
    Width          *int   `json:"width,omitempty"`   // 图片宽度
    Height         *int   `json:"height,omitempty"`  // 图片高度
    Duration       *int   `json:"duration,omitempty"` // 音频时长(秒)
    CreatedAt      int64  `json:"created_at"`
}

// MediaWithURL 带URL的媒体信息
type MediaWithURL struct {
    *Media
    OriginalURL  string `json:"original_url"`
    ThumbnailURL string `json:"thumbnail_url,omitempty"`
}

// UploadRequest 上传请求
type UploadRequest struct {
    File   multipart.File
    Header *multipart.FileHeader
    Type   string // image/voice
    OwnerID int64
}

// Service 媒体服务接口
type Service interface {
    // Upload 上传媒体文件
    Upload(req *UploadRequest) (*Media, error)

    // Get 获取媒体信息
    Get(id int64) (*Media, error)

    // GetWithURL 获取带URL的媒体信息
    GetWithURL(id int64, baseURL string) (*MediaWithURL, error)

    // GetFile 获取媒体文件
    GetFile(id int64) (string, string, error) // (path, mime_type, error)

    // GetThumbnail 获取缩略图
    GetThumbnail(id int64) (string, string, error) // (path, mime_type, error)

    // Delete 删除媒体文件
    Delete(id int64, userID int64) error

    // ValidateType 验证文件类型
    ValidateType(filename string, mimeType string) (string, error)

    // ValidateSize 验证文件大小
    ValidateSize(size int64, mediaType string) error
}
```

## 3. 内部设计

### 3.1 模块结构

```
media/
├── service.go          # 服务实现
├── handler.go          # HTTP处理器
├── storage.go          # 文件存储管理
├── processor.go        # 文件处理 (缩略图)
├── validator.go        # 文件验证
└── errors.go           # 错误定义
```

### 3.2 文件存储结构

```
data/
└── uploads/
    ├── original/       # 原始文件
    │   ├── 42.jpg
    │   ├── 43.mp3
    │   └── 44.png
    └── thumbnail/      # 缩略图
        ├── 42.jpg
        └── 44.jpg
```

### 3.3 上传流程

```
1. 接收上传请求
    │
2. 验证用户认证
    │
3. 验证文件类型
    │   ├─→ 检查扩展名
    │   ├─→ 检查MIME类型
    │   └─→ 验证文件头 (魔数)
    │
4. 验证文件大小
    │   ├─→ 图片: 最大5MB
    │   └─→ 语音: 最大10MB
    │
5. 生成唯一文件名 (使用Media ID)
    │
6. 保存原始文件
    │
7. 处理文件
    │   ├─→ 图片: 生成缩略图 (300x300)
    │   └─→ 语音: 提取元信息 (时长)
    │
8. 存储媒体记录到数据库
    │
9. 返回媒体信息
```

### 3.4 缩略图生成

```go
// 缩略图配置
const (
    ThumbnailSize  = 300  // 宽度300px
    ThumbnailQuality = 85 // JPEG质量
)

// 生成缩略图流程
1. 读取原始图片
2. 按比例缩放到ThumbnailSize宽度
3. 保持宽高比
4. 输出为JPEG格式
5. 保存到thumbnail目录
```

### 3.5 文件验证

```go
// 允许的文件类型
var allowedTypes = map[string][]string{
    "image": {".jpg", ".jpeg", ".png", ".gif", ".webp"},
    "voice": {".mp3", ".m4a", ".ogg", ".wav"},
}

// MIME类型映射
var mimeTypes = map[string]string{
    ".jpg":  "image/jpeg",
    ".jpeg": "image/jpeg",
    ".png":  "image/png",
    ".gif":  "image/gif",
    ".webp": "image/webp",
    ".mp3":  "audio/mpeg",
    ".m4a":  "audio/mp4",
    ".ogg":  "audio/ogg",
    ".wav":  "audio/wav",
}

// 文件头验证 (魔数)
var magicNumbers = map[string][]byte{
    "image/jpeg": {0xFF, 0xD8, 0xFF},
    "image/png":  {0x89, 0x50, 0x4E, 0x47},
    "image/gif":  {0x47, 0x49, 0x46},
    "audio/mpeg": {0xFF, 0xFB}, // 简化验证
}
```

### 3.6 音频元信息提取

```go
// 提取音频时长 (简单实现)
// 对于生产环境建议使用 https://github.com/dhowden/tag

type AudioInfo struct {
    Duration int    // 时长(秒)
    Bitrate  int    // 比特率
    Codec    string // 编码格式
}

func ExtractAudioInfo(path string) (*AudioInfo, error) {
    // 使用tag库读取音频元信息
    file, err := tag.ReadFile(path)
    if err != nil {
        return nil, err
    }

    return &AudioInfo{
        Duration: int(file.Length() / 1000), // 毫秒转秒
    }, nil
}
```

## 4. 数据模型

### 4.1 数据库表

```sql
CREATE TABLE media (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    owner_id INTEGER NOT NULL,
    type TEXT NOT NULL,  -- 'image', 'voice'
    original_path TEXT NOT NULL,
    thumbnail_path TEXT,
    size INTEGER NOT NULL,
    mime_type TEXT NOT NULL,
    width INTEGER,
    height INTEGER,
    duration INTEGER,
    created_at INTEGER NOT NULL,
    FOREIGN KEY (owner_id) REFERENCES users(id)
);

CREATE INDEX idx_media_owner ON media(owner_id);
CREATE INDEX idx_media_type ON media(type);
```

### 4.2 DAL接口

```go
package dal

type MediaDAL interface {
    Create(media *Media) error
    Get(id int64) (*Media, error)
    GetByOwner(ownerID int64) ([]*Media, error)
    Update(media *Media) error
    Delete(id int64) error
    MarkAsDeleted(id int64) error // 软删除
}
```

## 5. 错误处理

### 5.1 错误码

| 错误码 | 说明 |
|--------|------|
| MEDIA_INVALID_TYPE | 不支持的文件类型 |
| MEDIA_INVALID_SIZE | 文件大小超出限制 |
| MEDIA_INVALID_FORMAT | 文件格式无效 |
| MEDIA_UPLOAD_FAILED | 上传失败 |
| MEDIA_NOT_FOUND | 文件不存在 |
| MEDIA_ACCESS_DENIED | 无权访问 |
| MEDIA_DELETE_FAILED | 删除失败 |

### 5.2 HTTP状态码映射

| 错误码 | HTTP状态 |
|--------|----------|
| MEDIA_INVALID_* | 400 |
| MEDIA_UPLOAD_FAILED | 500 |
| MEDIA_NOT_FOUND | 404 |
| MEDIA_ACCESS_DENIED | 403 |

## 6. 安全考虑

### 6.1 文件安全

1. **类型验证**: 三重验证 (扩展名 + MIME + 魔数)
2. **大小限制**: 严格限制文件大小
3. **文件名**: 使用Media ID作为文件名, 避免路径遍历
4. **存储隔离**: 上传文件存储在专用目录

### 6.2 访问控制

```go
// 访问控制规则
// 1. 用户只能访问自己的文件
// 2. 例外: 头像可以公开访问
// 3. 消息中的媒体: 对话双方都可以访问

func (s *service) checkAccess(mediaID, userID int64, isPublic bool) error {
    media, err := s.dal.Get(mediaID)
    if err != nil {
        return ErrNotFound
    }

    // 公开资源 (如头像)
    if isPublic {
        return nil
    }

    // 只有所有者可以访问
    if media.OwnerID != userID {
        return ErrAccessDenied
    }

    return nil
}
```

## 7. 性能优化

### 7.1 静态文件服务

```go
// 使用embed嵌入静态资源 (可选)
// 或使用http.FileServer

func (h *Handler) ServeFile(w http.ResponseWriter, r *http.Request, id int64) {
    path, mimeType, err := h.service.GetFile(id)
    if err != nil {
        http.NotFound(w, r)
        return
    }

    // 设置缓存头
    w.Header().Set("Cache-Control", "public, max-age=31536000") // 1年
    w.Header().Set("Content-Type", mimeType)

    // 使用sendfile发送文件 (零拷贝)
    http.ServeFile(w, r, path)
}
```

### 7.2 并发上传限制

```go
// 限制同时上传数量
type UploadLimiter struct {
    sema chan struct{}
}

func NewUploadLimiter(max int) *UploadLimiter {
    return &UploadLimiter{
        sema: make(chan struct{}, max),
    }
}

func (l *UploadLimiter) Acquire() {
    l.sema <- struct{}{}
}

func (l *UploadLimiter) Release() {
    <-l.sema
}
```

## 8. 清理策略

```go
// 定期清理未使用的文件
// 1. 查找数据库中不存在的文件
// 2. 查找未被引用的媒体 (无消息引用)
// 3. 清理超过一定时间未使用的文件

type Cleaner struct {
    dal     dal.MediaDAL
    msgDal  dal.MessageDAL
    dataDir string
}

func (c *Cleaner) Cleanup() error {
    // 获取所有媒体记录
    media, err := c.dal.GetAll()
    if err != nil {
        return err
    }

    // 检查哪些文件未被引用
    for _, m := range media {
        referenced, err := c.msgDal.IsMediaReferenced(m.ID)
        if err != nil {
            continue
        }

        if !referenced && time.Since(time.Unix(m.CreatedAt, 0)) > 30*24*time.Hour {
            // 删除30天未使用的文件
            c.deleteMedia(m)
        }
    }

    return nil
}
```

## 9. 测试要点

- [ ] 上传图片 (JPG/PNG/GIF/WEBP)
- [ ] 上传语音 (MP3/M4A/OGG/WAV)
- [ ] 文件类型验证
- [ ] 文件大小限制
- [ ] 缩略图生成
- [ ] 音频时长提取
- [ ] 文件下载
- [ ] 缩略图下载
- [ ] 文件删除
- [ ] 访问控制
- [ ] 并发上传
