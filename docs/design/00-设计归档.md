# 设计归档

## 文档版本

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0 | 2026-02-11 | 初始版本 |

## 设计文档列表

| 文档 | 说明 |
|------|------|
| [01-整体架构设计](./01-整体架构设计.md) | 系统概述、技术选型、架构图、数据模型、通信协议 |
| [02-用户模块设计](./02-用户模块设计.md) | 用户注册、登录、认证鉴权、用户信息管理 |
| [03-连接模块设计](./03-连接模块设计.md) | WebSocket连接管理、消息路由、心跳保活 |
| [04-消息模块设计](./04-消息模块设计.md) | 消息存储、转发、同步、会话管理 |
| [05-媒体模块设计](./05-媒体模块设计.md) | 文件上传下载、缩略图生成、存储管理 |
| [06-客户端模块设计](./06-客户端模块设计.md) | 前端模块划分、接口定义、本地存储 |
| [07-API接口文档](./07-API接口文档.md) | REST API + WebSocket协议汇总 |

## 技术选型确认

### 后端
- 语言: Go 1.21+
- Web框架: Gin
- 数据库: SQLite
- WebSocket: gorilla/websocket
- 序列化: vmihailenco/msgpack

### 前端
- 框架: 原生 JavaScript (ES6+)
- 存储: IndexedDB
- WebSocket: 原生 API
- 序列化: msgpack-lite

### 部署
- HTTPS: 自签名证书
- 静态资源: 嵌入 Go 二进制

## 数据库Schema

```sql
-- 用户表
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    nickname TEXT NOT NULL,
    avatar_id INTEGER,
    created_at INTEGER NOT NULL,
    last_seen INTEGER NOT NULL,
    FOREIGN KEY (avatar_id) REFERENCES media(id)
);

-- 会话表
CREATE TABLE conversations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_a_id INTEGER NOT NULL,
    user_b_id INTEGER NOT NULL,
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    FOREIGN KEY (user_a_id) REFERENCES users(id),
    FOREIGN KEY (user_b_id) REFERENCES users(id),
    UNIQUE(user_a_id, user_b_id)
);

-- 消息表
CREATE TABLE messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    conversation_id INTEGER NOT NULL,
    sender_id INTEGER NOT NULL,
    receiver_id INTEGER NOT NULL,
    type TEXT NOT NULL,
    content TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'sent',
    created_at INTEGER NOT NULL,
    synced_at INTEGER,
    FOREIGN KEY (conversation_id) REFERENCES conversations(id),
    FOREIGN KEY (sender_id) REFERENCES users(id),
    FOREIGN KEY (receiver_id) REFERENCES users(id)
);

-- 媒体文件表
CREATE TABLE media (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    owner_id INTEGER NOT NULL,
    type TEXT NOT NULL,
    original_path TEXT NOT NULL,
    thumbnail_path TEXT,
    size INTEGER NOT NULL,
    mime_type TEXT NOT NULL,
    width INTEGER,
    height INTEGER,
    duration INTEGER,
    created_at INTEGER NOT NULL,
    FOREIGN KEY (owner_id) REFERENCES users(id)
);

-- 分享表
CREATE TABLE shared_conversations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    conversation_id INTEGER NOT NULL,
    share_token TEXT UNIQUE NOT NULL,
    created_by INTEGER NOT NULL,
    expire_at INTEGER NOT NULL,
    created_at INTEGER NOT NULL,
    FOREIGN KEY (conversation_id) REFERENCES conversations(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

## 通信协议

### REST API (HTTPS)
- Content-Type: application/json
- 认证: Bearer Token (JWT)

### WebSocket (WSS)
- 消息编码: MessagePack
- 心跳间隔: 30秒
- 消息类型: 认证、聊天、确认、同步、状态、心跳

## 项目结构

```
zMessage/
├── server/                    # 服务端代码
│   ├── main.go               # 入口
│   ├── api/                  # HTTP API
│   ├── ws/                   # WebSocket
│   ├── modules/              # 业务模块
│   │   ├── user/
│   │   ├── message/
│   │   ├── conversation/
│   │   ├── media/
│   │   └── sync/
│   ├── dal/                  # 数据访问层
│   ├── models/               # 数据模型
│   ├── pkg/                  # 工具包
│   └── config/               # 配置
├── client/                   # 客户端代码
│   ├── index.html
│   └── assets/
├── data/                     # 数据目录
└── docs/                     # 文档
```

## 修改记录

| 日期 | 内容 | 影响文档 |
|------|------|----------|
| 2026-02-11 | 初始设计完成 | 全部 |
