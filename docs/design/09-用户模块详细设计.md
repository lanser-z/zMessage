# 用户模块详细设计

## 1. 模块概述

### 1.1 职责
- 用户注册
- 用户登录
- JWT Token生成和验证
- 密码哈希和验证
- 用户信息管理

### 1.2 依赖
- 数据访问层 (DAL)
- JWT工具包
- bcrypt工具包

### 1.3 被依赖
- 连接模块 (认证)
- 消息模块 (用户信息)

## 2. 接口定义

```go
package user

import (
    "context"
    "time"
    "zmessage/server/models"
)

// RegisterRequest 注册请求
type RegisterRequest struct {
    Username string `json:"username" validate:"required,min=3,max=20,alphanum"`
    Password string `json:"password" validate:"required,min=6,max=32"`
    Nickname string `json:"nickname" validate:"omitempty,max=50"`
}

// LoginRequest 登录请求
type LoginRequest struct {
    Username string `json:"username" validate:"required"`
    Password string `json:"password" validate:"required"`
}

// UpdateRequest 更新用户信息请求
type UpdateRequest struct {
    Nickname *string `json:"nickname" validate:"omitempty,max=50"`
    AvatarID *int64  `json:"avatar_id"`
}

// AuthResponse 认证响应
type AuthResponse struct {
    User  *models.User `json:"user"`
    Token string        `json:"token"`
}

// UserResponse 用户信息响应（不含敏感信息）
type UserResponse struct {
    ID        int64  `json:"id"`
    Username  string `json:"username"`
    Nickname  string `json:"nickname"`
    Avatar    string `json:"avatar,omitempty"`
    CreatedAt int64  `json:"created_at"`
}

// Service 用户服务接口
type Service interface {
    // Register 用户注册
    Register(ctx context.Context, req *RegisterRequest) (*AuthResponse, error)

    // Login 用户登录
    Login(ctx context.Context, req *LoginRequest) (*AuthResponse, error)

    // GetUserByID 根据ID获取用户
    GetUserByID(ctx context.Context, id int64) (*models.User, error)

    // GetUserByUsername 根据用户名获取用户
    GetUserByUsername(ctx context.Context, username string) (*models.User, error)

    // GetUsers 获取用户列表
    GetUsers(ctx context.Context, search string, limit int) ([]*models.User, error)

    // UpdateUser 更新用户信息
    UpdateUser(ctx context.Context, id int64, req *UpdateRequest) (*models.User, error)

    // UpdateLastSeen 更新最后活跃时间
    UpdateLastSeen(ctx context.Context, id int64) error

    // ValidateToken 验证Token，返回用户ID
    ValidateToken(token string) (int64, error)

    // GenerateToken 生成Token
    GenerateToken(userID int64) (string, error)
}

// OnlineStatusManager 在线状态管理器接口
type OnlineStatusManager interface {
    // SetOnline 设置用户在线状态
    SetOnline(userID int64, online bool)

    // IsOnline 检查用户是否在线
    IsOnline(userID int64) bool

    // GetOnlineUsers 获取在线用户列表
    GetOnlineUsers() []int64
}
```

## 3. 内部实现

### 3.1 用户服务

```go
type service struct {
    dal      dal.Manager
    jwt      *JWTManager
    online   OnlineStatusManager
    password PasswordHasher
}

func NewService(dal dal.Manager, secret string) Service {
    return &service{
        dal:      dal,
        jwt:      NewJWTManager(secret),
        online:   NewOnlineStatusManager(),
        password: NewBcryptHasher(),
    }
}
```

### 3.2 密码哈希

```go
// PasswordHasher 密码哈希接口
type PasswordHasher interface {
    // Hash 哈希密码
    Hash(password string) (string, error)

    // Verify 验证密码
    Verify(hash, password string) bool
}

// BcryptHasher bcrypt实现
type BcryptHasher struct {
    cost int
}

func NewBcryptHasher() *BcryptHasher {
    return &BcryptHasher{cost: 10}
}

func (b *BcryptHasher) Hash(password string) (string, error) {
    bytes, err := bcrypt.GenerateFromPassword([]byte(password), b.cost)
    return string(bytes), err
}

func (b *BcryptHasher) Verify(hash, password string) bool {
    err := bcrypt.CompareHashAndPassword([]byte(hash), []byte(password))
    return err == nil
}
```

### 3.3 JWT管理

```go
// JWTManager JWT管理器
type JWTManager struct {
    secret     []byte
    expiration time.Duration
}

// Claims JWT声明
type Claims struct {
    UserID int64 `json:"user_id"`
    jwt.RegisteredClaims
}

func NewJWTManager(secret string) *JWTManager {
    return &JWTManager{
        secret:     []byte(secret),
        expiration: 7 * 24 * time.Hour, // 7天
    }
}

func (j *JWTManager) GenerateToken(userID int64) (string, error) {
    claims := Claims{
        UserID: userID,
        RegisteredClaims: jwt.RegisteredClaims{
            ExpiresAt: time.Now().Add(j.expiration).Unix(),
            IssuedAt:  time.Now().Unix(),
            Subject:    strconv.FormatInt(userID, 10),
        },
    }

    token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)
    return token.SignedString(j.secret)
}

func (j *JWTManager) ValidateToken(tokenString string) (int64, error) {
    token, err := jwt.ParseWithClaims(tokenString, &Claims{}, func(token *jwt.Token) (interface{}, error) {
        if _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok {
            return nil, fmt.Errorf("unexpected signing method: %v", token.Header["alg"])
        }
        return j.secret, nil
    })

    if err != nil {
        return 0, err
    }

    if claims, ok := token.Claims.(*Claims); ok && token.Valid {
        return claims.UserID, nil
    }

    return 0, fmt.Errorf("invalid token")
}
```

### 3.4 在线状态管理

```go
// onlineStatusManager 在线状态管理器
type onlineStatusManager struct {
    users map[int64]bool
    mu    sync.RWMutex
}

func NewOnlineStatusManager() *onlineStatusManager {
    return &onlineStatusManager{
        users: make(map[int64]bool),
    }
}

func (m *onlineStatusManager) SetOnline(userID int64, online bool) {
    m.mu.Lock()
    defer m.mu.Unlock()
    m.users[userID] = online
}

func (m *onlineStatusManager) IsOnline(userID int64) bool {
    m.mu.RLock()
    defer m.mu.RUnlock()
    return m.users[userID]
}

func (m *onlineStatusManager) GetOnlineUsers() []int64 {
    m.mu.RLock()
    defer m.mu.RUnlock()

    var users []int64
    for userID, online := range m.users {
        if online {
            users = append(users, userID)
        }
    }
    return users
}
```

## 4. 错误定义

```go
var (
    ErrInvalidUsername    = errors.New("invalid username")
    ErrInvalidPassword    = errors.New("invalid password")
    ErrUserExists        = errors.New("user already exists")
    ErrUserNotFound      = errors.New("user not found")
    ErrInvalidToken      = errors.New("invalid token")
    ErrTokenExpired      = errors.New("token expired")
    ErrWeakPassword      = errors.New("password too weak")
)
```

## 5. 业务流程

### 5.1 注册流程

```
1. 验证请求参数
    │
2. 检查用户名是否已存在
    │   └─→ 存在: 返回 ErrUserExists
    │
3. 哈希密码 (bcrypt, cost=10)
    │
4. 创建用户记录
    │
5. 生成JWT Token
    │
6. 返回用户信息和Token
```

### 5.2 登录流程

```
1. 验证请求参数
    │
2. 根据用户名查询用户
    │   └─→ 不存在: 返回 ErrUserNotFound
    │
3. 验证密码 (bcrypt)
    │   └─→ 错误: 返回 ErrInvalidPassword
    │
4. 更新最后活跃时间
    │
5. 生成JWT Token
    │
6. 返回用户信息和Token
```

### 5.3 Token验证流程

```
1. 解析JWT Token
    │
2. 验证签名
    │
3. 检查过期时间
    │   └─→ 过期: 返回 ErrTokenExpired
    │
4. 返回用户ID
```

## 6. HTTP处理器

```go
// Handler HTTP处理器
type Handler struct {
    service Service
}

// RegisterHandler 注册处理器
func (h *Handler) RegisterHandler(c *gin.Context)

// LoginHandler 登录处理器
func (h *Handler) LoginHandler(c *gin.Context)

// GetMeHandler 获取当前用户信息
func (h *Handler) GetMeHandler(c *gin.Context)

// ListUsersHandler 获取用户列表
func (h *Handler) ListUsersHandler(c *gin.Context)

// GetUserHandler 获取指定用户信息
func (h *Handler) GetUserHandler(c *gin.Context)

// UpdateMeHandler 更新当前用户信息
func (h *Handler) UpdateMeHandler(c *gin.Context)
```

## 7. 测试要点

- [ ] 注册成功流程
- [ ] 注册重复用户名
- [ ] 注册参数验证（用户名格式、密码长度）
- [ ] 登录成功流程
- [ ] 登录错误密码
- [ ] 登录不存在的用户
- [ ] JWT Token生成
- [ ] JWT Token验证（有效、过期、无效）
- [ ] 密码哈希和验证
- [ ] 在线状态管理
- [ ] 用户列表和搜索
- [ ] 更新用户信息
