# 数据访问层(DAL)设计

## 1. 模块概述

### 1.1 职责
- 数据库连接管理
- 数据库初始化和迁移
- 用户数据CRUD操作
- 会话数据CRUD操作
- 消息数据CRUD操作
- 媒体数据CRUD操作

### 1.2 技术选型
- 数据库: SQLite3
- 驱动: github.com/mattn/go-sqlite3
- ORM: 无 (原生SQL，保持轻量)

### 1.3 依赖
- 无 (最底层模块)

## 2. 数据库Schema

```sql
-- 用户表
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    nickname TEXT NOT NULL,
    avatar_id INTEGER,
    created_at INTEGER NOT NULL,
    last_seen INTEGER NOT NULL,
    FOREIGN KEY (avatar_id) REFERENCES media(id)
);

-- 会话表
CREATE TABLE IF NOT EXISTS conversations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_a_id INTEGER NOT NULL,
    user_b_id INTEGER NOT NULL,
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    FOREIGN KEY (user_a_id) REFERENCES users(id),
    FOREIGN KEY (user_b_id) REFERENCES users(id),
    UNIQUE(user_a_id, user_b_id)
);

-- 消息表
CREATE TABLE IF NOT EXISTS messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    conversation_id INTEGER NOT NULL,
    sender_id INTEGER NOT NULL,
    receiver_id INTEGER NOT NULL,
    type TEXT NOT NULL,
    content TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'sent',
    created_at INTEGER NOT NULL,
    synced_at INTEGER,
    FOREIGN KEY (conversation_id) REFERENCES conversations(id),
    FOREIGN KEY (sender_id) REFERENCES users(id),
    FOREIGN KEY (receiver_id) REFERENCES users(id)
);

-- 媒体文件表
CREATE TABLE IF NOT EXISTS media (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    owner_id INTEGER NOT NULL,
    type TEXT NOT NULL,
    original_path TEXT NOT NULL,
    thumbnail_path TEXT,
    size INTEGER NOT NULL,
    mime_type TEXT NOT NULL,
    width INTEGER,
    height INTEGER,
    duration INTEGER,
    created_at INTEGER NOT NULL,
    FOREIGN KEY (owner_id) REFERENCES users(id)
);

-- 分享表
CREATE TABLE IF NOT EXISTS shared_conversations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    conversation_id INTEGER NOT NULL,
    share_token TEXT UNIQUE NOT NULL,
    created_by INTEGER NOT NULL,
    expire_at INTEGER NOT NULL,
    created_at INTEGER NOT NULL,
    FOREIGN KEY (conversation_id) REFERENCES conversations(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- 索引
CREATE INDEX IF NOT EXISTS idx_messages_conversation ON messages(conversation_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_messages_receiver_status ON messages(receiver_id, status) WHERE status != 'read';
CREATE INDEX IF NOT EXISTS idx_conversations_users ON conversations(user_a_id, user_b_id);
CREATE INDEX IF NOT EXISTS idx_conversations_updated ON conversations(updated_at DESC);
CREATE INDEX IF NOT EXISTS idx_media_owner ON media(owner_id);
CREATE INDEX IF NOT EXISTS idx_media_type ON media(type);
```

## 3. 接口定义

### 3.1 数据库管理器

```go
package dal

import "database/sql"

// DB 数据库接口
type DB interface {
    Close() error
    Begin() (*sql.Tx, error)
    Exec(query string, args ...interface{}) (sql.Result, error)
    Query(query string, args ...interface{}) (*sql.Rows, error)
    QueryRow(query string, args ...interface{}) *sql.Row
}

// Manager 数据库管理器
type Manager interface {
    // DB 获取数据库连接
    DB() DB

    // User 用户数据访问
    User() UserDAL

    // Conversation 会话数据访问
    Conversation() ConversationDAL

    // Message 消息数据访问
    Message() MessageDAL

    // Media 媒体数据访问
    Media() MediaDAL

    // SharedConversation 分享数据访问
    SharedConversation() SharedConversationDAL

    // Close 关闭数据库连接
    Close() error
}
```

### 3.2 用户数据访问

```go
package dal

// User 用户实体
type User struct {
    ID           int64
    Username     string
    PasswordHash string
    Nickname     string
    AvatarID     *int64
    CreatedAt    int64
    LastSeen     int64
}

// UserDAL 用户数据访问接口
type UserDAL interface {
    // Create 创建用户
    Create(user *User) error

    // GetByID 根据ID获取用户
    GetByID(id int64) (*User, error)

    // GetByUsername 根据用户名获取用户
    GetByUsername(username string) (*User, error)

    // List 获取用户列表
    List(search string, limit int) ([]*User, error)

    // Update 更新用户
    Update(user *User) error

    // UpdateLastSeen 更新最后活跃时间
    UpdateLastSeen(id int64, lastSeen int64) error

    // Delete 删除用户
    Delete(id int64) error

    // Count 获取用户总数
    Count() (int, error)
}
```

### 3.3 会话数据访问

```go
package dal

// Conversation 会话实体
type Conversation struct {
    ID        int64
    UserAID   int64
    UserBID   int64
    CreatedAt int64
    UpdatedAt int64
}

// ConversationDAL 会话数据访问接口
type ConversationDAL interface {
    // Create 创建会话
    Create(conv *Conversation) error

    // GetByID 根据ID获取会话
    GetByID(id int64) (*Conversation, error)

    // GetByUsers 根据两个用户ID获取会话
    GetByUsers(userA, userB int64) (*Conversation, error)

    // GetByUser 获取用户的所有会话
    GetByUser(userID int64, page, limit int) ([]*Conversation, int, error)

    // Update 更新会话
    Update(conv *Conversation) error

    // UpdateTime 更新会话时间
    UpdateTime(id int64, updatedAt int64) error

    // Delete 删除会话
    Delete(id int64) error
}
```

### 3.4 消息数据访问

```go
package dal

// Message 消息实体
type Message struct {
    ID             int64
    ConversationID int64
    SenderID       int64
    ReceiverID     int64
    Type           string
    Content        string
    Status         string
    CreatedAt      int64
    SyncedAt       *int64
}

// MessageDAL 消息数据访问接口
type MessageDAL interface {
    // Create 创建消息
    Create(msg *Message) error

    // GetByID 根据ID获取消息
    GetByID(id int64) (*Message, error)

    // GetByConversation 根据会话ID获取消息列表
    GetByConversation(convID int64, beforeID int64, limit int) ([]*Message, error)

    // GetOfflineMessages 获取离线消息
    GetOfflineMessages(userID int64, lastID int64, limit int) ([]*Message, error)

    // Update 更新消息
    Update(msg *Message) error

    // UpdateStatus 更新消息状态
    UpdateStatus(id int64, status string) error

    // UpdateMessagesStatus 批量更新消息状态
    UpdateMessagesStatus(convID int64, receiverID int64, status string) error

    // CountUnread 统计未读消息数
    CountUnread(convID int64, userID int64) (int, error)

    // CountTotalUnread 统计用户总未读消息数
    CountTotalUnread(userID int64) (int, error)

    // Delete 删除消息
    Delete(id int64) error
}
```

### 3.5 媒体数据访问

```go
package dal

// Media 媒体实体
type Media struct {
    ID            int64
    OwnerID       int64
    Type          string
    OriginalPath  string
    ThumbnailPath string
    Size          int64
    MimeType      string
    Width         *int
    Height        *int
    Duration      *int
    CreatedAt     int64
}

// MediaDAL 媒体数据访问接口
type MediaDAL interface {
    // Create 创建媒体记录
    Create(media *Media) error

    // GetByID 根据ID获取媒体
    GetByID(id int64) (*Media, error)

    // GetByOwner 获取用户的所有媒体
    GetByOwner(ownerID int64) ([]*Media, error)

    // Update 更新媒体
    Update(media *Media) error

    // Delete 删除媒体
    Delete(id int64) error
}
```

### 3.6 分享数据访问

```go
package dal

// SharedConversation 分享的会话实体
type SharedConversation struct {
    ID             int64
    ConversationID int64
    ShareToken     string
    CreatedBy      int64
    ExpireAt       int64
    CreatedAt      int64
}

// SharedConversationDAL 分享数据访问接口
type SharedConversationDAL interface {
    // Create 创建分享
    Create(sc *SharedConversation) error

    // GetByID 根据ID获取分享
    GetByID(id int64) (*SharedConversation, error)

    // GetByToken 根据Token获取分享
    GetByToken(token string) (*SharedConversation, error)

    // GetByConversation 获取会话的所有分享
    GetByConversation(convID int64) ([]*SharedConversation, error)

    // Delete 删除分享
    Delete(id int64) error

    // DeleteExpired 删除过期的分享
    DeleteExpired() error
}
```

## 4. 错误处理

```go
package dal

import "errors"

var (
    // ErrNotFound 记录不存在
    ErrNotFound = errors.New("record not found")

    // ErrDuplicate 唯一约束冲突
    ErrDuplicate = errors.New("duplicate record")

    // ErrInvalidArgument 无效参数
    ErrInvalidArgument = errors.New("invalid argument")

    // ErrInternal 内部错误
    ErrInternal = errors.New("internal error")
)
```

## 5. 实现细节

### 5.1 数据库初始化流程

```
1. 打开数据库连接
    │
2. 执行Schema创建表
    │
3. 创建索引
    │
4. 返回Manager实例
```

### 5.2 连接管理

- 使用单例模式
- 支持事务
- 连接池配置

### 5.3 SQL注入防护

- 使用参数化查询
- 所有外部输入都作为参数传递

## 6. 测试要点

- [ ] 数据库初始化
- [ ] 用户CRUD操作
- [ ] 会话CRUD操作
- [ ] 消息CRUD操作
- [ ] 媒体CRUD操作
- [ ] 索引有效性
- [ ] 事务支持
- [ ] 错误处理
