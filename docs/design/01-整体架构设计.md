# 整体架构设计

## 1. 系统概述

### 1.1 产品定位
- 私有协议小团队IM系统
- 支持50用户注册，20并发
- 1对1聊天（文字、语音、图片）
- 可分享对话

### 1.2 技术选型

#### 后端技术栈
| 技术 | 选型 | 理由 |
|------|------|------|
| 语言 | Go 1.21+ | 轻量、并发好、二进制部署简单 |
| Web框架 | Gin | 轻量高性能，生态成熟 |
| 数据库 | SQLite | 无需独立服务，单文件存储，适合50用户规模 |
| 通信协议 | WebSocket + HTTP | 实时通信 + REST API |
| 序列化 | MessagePack | 支持压缩，比JSON小30-50% |
| 媒体存储 | 本地文件系统 | 简单可控 |

#### 前端技术栈
| 技术 | 选型 | 理由 |
|------|------|------|
| 框架 | 原生JavaScript | 最轻量，无额外依赖 |
| 模块化 | ES6 Modules | 现代浏览器原生支持 |
| 状态管理 | 简单Store模式 | 小规模应用够用 |
| 本地存储 | IndexedDB | 存储聊天历史 |
| 样式 | 原生CSS | 无预处理器依赖 |

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端 (移动浏览器)                        │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐            │
│  │ 认证模块 │  │ 消息模块 │  │ 媒体模块 │  │ UI模块  │            │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘            │
│       │            │            │            │                   │
│  ┌────┴────────────┴────────────┴────────────┴────────┐        │
│  │           连接模块 (WebSocket + HTTP)                │        │
│  └─────────────────────────┬───────────────────────────┘        │
└────────────────────────────┼───────────────────────────────────┘
                               │
                    ┌──────────┴──────────┐
                    │   网络边界 (HTTP)    │
                    └──────────┬──────────┘
                               │
┌─────────────────────────────────────────────────────────────────┐
│                        服务端 (本机)                              │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    API Gateway                           │   │
│  │         (WebSocket Handler + HTTP Router)                │   │
│  └────────┬────────────────────────────────────────────┬────┘   │
│           │                                            │         │
│  ┌────────┴────┐  ┌──────────┐  ┌──────────┐  ┌──────┴────┐   │
│  │  用户模块   │  │ 连接模块  │  │ 消息模块  │  │  媒体模块  │   │
│  │            │  │          │  │          │  │           │   │
│  │ - 注册登录 │  │ - 连接管理│  │ - 消息存储│  │ - 文件上传│   │
│  │ - 认证鉴权 │  │ - 心跳保活│  │ - 消息转发│  │ - 缩略图  │   │
│  │ - 用户信息 │  │ - 离线推送│  │ - 同步机制│  │ - 存储管理 │   │
│  └────────────┘  └──────────┘  └──────────┘  └───────────┘   │
│         │                                            │         │
│  ┌──────┴────────────────────────────────────────────┴───────┐ │
│  │                    数据访问层 (DAL)                        │ │
│  │             (用户数据 | 消息数据 | 会话数据)                │ │
│  └──────────────────────────┬───────────────────────────────┘ │
│                             │                                   │
│  ┌──────────────────────────┴───────────────────────────────┐ │
│  │                    SQLite Database                         │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                   本地文件存储                              │ │
│  │          (上传文件 | 缩略图 | 附件)                          │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 部署架构

```
┌─────────────────────────────────────┐
│           用户设备 (手机)             │
│      Chrome Mobile Browser          │
└──────────────┬──────────────────────┘
               │ HTTPS/WSS
               │
┌──────────────┴──────────────────────┐
│         服务端 (本机PC)               │
│  ┌───────────────────────────────┐  │
│  │   zMessage Server (单进程)     │  │
│  │   - HTTP  :8443               │  │
│  │   - HTTPS :8443               │  │
│  │   - WS    :8443/ws            │  │
│  │   - WSS   :8443/ws            │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │   SQLite: data/messages.db    │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │   Files: data/uploads/        │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

## 3. 模块划分

### 3.1 服务端模块

| 模块 | 职责 | 依赖 |
|------|------|------|
| 用户模块 | 用户注册、登录、认证鉴权、用户信息管理 | 数据访问层 |
| 连接模块 | WebSocket连接管理、心跳保活、离线消息推送 | 用户模块、消息模块 |
| 消息模块 | 消息存储、消息转发、消息同步、会话管理 | 数据访问层 |
| 媒体模块 | 文件上传、缩略图生成、存储管理 | 数据访问层、文件系统 |

### 3.2 客户端模块

| 模块 | 职责 | 依赖 |
|------|------|------|
| 认证模块 | 登录注册、Token管理 | 连接模块 |
| 连接模块 | WebSocket连接管理、重连机制 | - |
| 消息模块 | 消息收发、本地存储、同步逻辑 | 连接模块 |
| 媒体模块 | 图片/语音选择、预览、上传 | 连接模块 |
| UI模块 | 聊天界面、联系人列表、设置 | 所有模块 |

## 4. 数据模型

### 4.1 核心实体

```
User (用户)
├── ID: 用户唯一标识
├── Username: 用户名
├── PasswordHash: 密码哈希
├── Nickname: 昵称
├── Avatar: 头像URL
├── CreatedAt: 注册时间
└── LastSeen: 最后活跃时间

Conversation (会话)
├── ID: 会话ID
├── ParticipantA: 参与者A的User ID
├── ParticipantB: 参与者B的User ID
├── CreatedAt: 创建时间
└── UpdatedAt: 最后消息时间

Message (消息)
├── ID: 消息ID
├── ConversationID: 所属会话ID
├── SenderID: 发送者User ID
├── ReceiverID: 接收者User ID
├── Type: 消息类型 (text/voice/image)
├── Content: 消息内容/媒体ID
├── Status: 发送状态 (sent/delivered/read)
├── CreatedAt: 发送时间
└── SyncedAt: 同步时间

Media (媒体文件)
├── ID: 文件ID
├── OwnerID: 上传者User ID
├── Type: 文件类型 (image/voice)
├── OriginalPath: 原始文件路径
├── ThumbnailPath: 缩略图路径
├── Size: 文件大小
├── MimeType: MIME类型
└── CreatedAt: 上传时间

SharedConversation (分享的会话)
├── ID: 分享ID
├── ConversationID: 原会话ID
├── ShareToken: 分享令牌
├── CreatedBy: 分享者User ID
├── ExpireAt: 过期时间
└── CreatedAt: 创建时间
```

### 4.2 数据库表结构

```sql
-- 用户表
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    nickname TEXT NOT NULL,
    avatar TEXT,
    created_at INTEGER NOT NULL,
    last_seen INTEGER NOT NULL
);

-- 会话表
CREATE TABLE conversations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_a_id INTEGER NOT NULL,
    user_b_id INTEGER NOT NULL,
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    FOREIGN KEY (user_a_id) REFERENCES users(id),
    FOREIGN KEY (user_b_id) REFERENCES users(id),
    UNIQUE(user_a_id, user_b_id)
);

-- 消息表
CREATE TABLE messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    conversation_id INTEGER NOT NULL,
    sender_id INTEGER NOT NULL,
    receiver_id INTEGER NOT NULL,
    type TEXT NOT NULL,  -- 'text', 'voice', 'image'
    content TEXT NOT NULL,
    status TEXT NOT NULL,  -- 'sent', 'delivered', 'read'
    created_at INTEGER NOT NULL,
    synced_at INTEGER,
    FOREIGN KEY (conversation_id) REFERENCES conversations(id),
    FOREIGN KEY (sender_id) REFERENCES users(id),
    FOREIGN KEY (receiver_id) REFERENCES users(id)
);

-- 媒体文件表
CREATE TABLE media (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    owner_id INTEGER NOT NULL,
    type TEXT NOT NULL,  -- 'image', 'voice'
    original_path TEXT NOT NULL,
    thumbnail_path TEXT,
    size INTEGER NOT NULL,
    mime_type TEXT NOT NULL,
    created_at INTEGER NOT NULL,
    FOREIGN KEY (owner_id) REFERENCES users(id)
);

-- 分享表
CREATE TABLE shared_conversations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    conversation_id INTEGER NOT NULL,
    share_token TEXT UNIQUE NOT NULL,
    created_by INTEGER NOT NULL,
    expire_at INTEGER NOT NULL,
    created_at INTEGER NOT NULL,
    FOREIGN KEY (conversation_id) REFERENCES conversations(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- 索引
CREATE INDEX idx_messages_conversation ON messages(conversation_id, created_at);
CREATE INDEX idx_messages_sender ON messages(sender_id, created_at);
CREATE INDEX idx_messages_receiver ON messages(receiver_id, created_at);
CREATE INDEX idx_conversations_user ON conversations(user_a_id, user_b_id);
```

## 5. 通信协议设计

### 5.1 协议选择

| 场景 | 协议 | 序列化 |
|------|------|--------|
| 实时消息 | WebSocket | MessagePack |
| REST API | HTTPS | JSON (API) / MessagePack (Body) |
| 媒体上传 | HTTPS POST | multipart/form-data |

### 5.2 WebSocket消息格式

使用MessagePack编码的二进制格式：

```go
// WebSocket消息结构
type WSMessage struct {
    Type    MessageType `msgpack:"type"`    // 消息类型
    Seq     int64       `msgpack:"seq"`     // 序列号
    Payload []byte      `msgpack:"payload"` // 消息负载
}

type MessageType int
const (
    // 客户端→服务端
    MsgAuth        MessageType = 1  // 认证
    MsgChat        MessageType = 2  // 聊天消息
    MsgAck         MessageType = 3  // 确认
    MsgSyncReq     MessageType = 4  // 同步请求
    MsgPresence    MessageType = 5  // 在线状态
    MsgPing        MessageType = 6  // 心跳

    // 服务端→客户端
    MsgChatPush    MessageType = 101 // 消息推送
    MsgSyncRsp     MessageType = 102 // 同步响应
    MsgPresencePush MessageType = 103 // 在线状态推送
    MsgPong        MessageType = 104 // 心跳响应
    MsgError       MessageType = 105 // 错误
)
```

### 5.3 REST API端点

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/auth/register | 用户注册 |
| POST | /api/auth/login | 用户登录 |
| GET  | /api/users/me | 获取当前用户信息 |
| GET  | /api/users | 获取用户列表 |
| GET  | /api/conversations | 获取会话列表 |
| GET  | /api/conversations/:id | 获取会话详情 |
| GET  | /api/conversations/:id/messages | 获取消息历史 |
| POST | /api/media/upload | 上传媒体文件 |
| GET  | /api/media/:id | 获取媒体文件 |
| POST | /api/conversations/:id/share | 分享会话 |
| GET  | /api/shared/:token | 获取分享的会话 |

## 6. 消息同步机制

### 6.1 同步策略

1. **在线同步**: 通过WebSocket实时推送
2. **离线同步**: 客户端上线时主动拉取
3. **同步窗口**: 10秒延迟内可接受
4. **增量同步**: 基于消息ID或时间戳

### 6.2 同步流程

```
客户端上线
    │
    ├─→ WebSocket连接成功
    │       │
    │       ├─→ 发送认证消息 (MsgAuth)
    │       │       │
    │       │       └─→ 服务端验证Token
    │       │               │
    │       │               ├─→ 成功: 返回在线状态
    │       │               └─→ 失败: 断开连接
    │       │
    │       ├─→ 发送同步请求 (MsgSyncReq)
    │       │       │
    │       │       └─→ 服务端返回离线消息
    │       │
    │       └─→ 开始接收实时消息推送
    │
    └─→ 消息确认 (MsgAck)
            │
            └─→ 更新消息状态 (delivered/read)
```

## 7. 安全设计

### 7.1 认证鉴权

- 使用JWT (JSON Web Token)进行认证
- Token有效期: 7天
- 支持Token刷新
- HTTPS/WSS加密传输

### 7.2 数据安全

- 密码使用bcrypt哈希存储
- 用户上传文件进行类型验证
- 文件大小限制: 图片5MB, 语音10MB
- 分享链接带过期时间

### 7.3 防护措施

- API请求频率限制
- WebSocket连接数限制 (单用户最多3个连接)
- 输入验证和XSS防护
- SQL注入防护 (使用参数化查询)

## 8. 性能指标

| 指标 | 目标值 |
|------|--------|
| 并发用户 | 20 |
| 注册用户 | 50 |
| 消息延迟 | <10秒 |
| 单消息大小 | <10KB |
| WebSocket连接 | 3/用户 |
| API响应时间 | <200ms (p95) |
| 数据库大小 | <100MB |

## 9. 项目结构

### 9.1 服务端结构

```
zMessage/
├── server/                    # 服务端代码
│   ├── main.go               # 入口
│   ├── api/                  # HTTP API
│   │   ├── handlers/         # 请求处理器
│   │   └── routes/           # 路由定义
│   ├── ws/                   # WebSocket
│   │   ├── handler.go        # WebSocket处理器
│   │   └── manager.go        # 连接管理
│   ├── modules/              # 业务模块
│   │   ├── user/            # 用户模块
│   │   ├── message/         # 消息模块
│   │   ├── conversation/    # 会话模块
│   │   ├── media/           # 媒体模块
│   │   └── sync/            # 同步模块
│   ├── dal/                  # 数据访问层
│   │   ├── user.go
│   │   ├── message.go
│   │   ├── conversation.go
│   │   └── media.go
│   ├── models/               # 数据模型
│   ├── pkg/                  # 工具包
│   │   ├── auth/            # 认证
│   │   ├── msgpack/         # 序列化
│   │   └── validator/       # 验证
│   └── config/               # 配置
├── client/                   # 客户端代码
│   ├── index.html
│   ├── assets/
│   │   ├── css/
│   │   └── js/
│   │       ├── modules/     # 模块
│   │       │   ├── auth.js
│   │       │   ├── connection.js
│   │       │   ├── message.js
│   │       │   ├── media.js
│   │       │   └── ui.js
│   │       ├── store/       # 本地存储
│   │       ├── protocol/    # 协议处理
│   │       └── utils/       # 工具
│   └── assets.go            # 嵌入静态资源
├── data/                     # 数据目录
│   ├── messages.db          # SQLite数据库
│   └── uploads/             # 上传文件
├── docs/                     # 文档
│   ├── design/              # 设计文档
│   └── api/                 # API文档
└── scripts/                  # 脚本
    └── build.sh
```

### 9.2 开发环境

```bash
# 项目级Go环境
zMessage/
├── .go/                      # Go工具缓存
├── go.mod                    # Go模块定义
└── go.sum                    # 依赖锁定

# 运行
go run server/main.go

# 构建
go build -o zmessage server/main.go
```

## 10. 开发计划

### 阶段1: 基础框架
- [ ] 项目初始化
- [ ] 数据库设计实现
- [ ] API框架搭建
- [ ] WebSocket基础

### 阶段2: 核心模块
- [ ] 用户模块
- [ ] 连接模块
- [ ] 消息模块

### 阶段3: 媒体功能
- [ ] 媒体上传下载
- [ ] 缩略图生成

### 阶段4: 客户端
- [ ] 基础UI
- [ ] 消息收发
- [ ] 媒体功能

### 阶段5: 测试优化
- [ ] 单元测试
- [ ] 集成测试
- [ ] 性能优化
