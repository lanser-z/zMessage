# 连接模块设计

## 1. 模块概述

### 1.1 职责
- SSE 连接管理
- 连接认证
- 心跳保活
- 消息推送
- 在线状态管理

### 1.2 依赖
- 用户模块 (认证)
- 消息模块 (离线消息)

### 1.3 被依赖
- 客户端连接模块

## 2. 对外接口

### 2.1 SSE 端点

#### GET /api/sse/subscribe
SSE 订阅端点

**连接 URL:**
```
http://localhost:9405/api/sse/subscribe?token=<jwt_token>
https://localhost:9405/api/sse/subscribe?token=<jwt_token>
```

**连接流程:**
```
1. 客户端建立 SSE 连接（携带 token）
2. 服务端验证 Token
3. 返回 connected 事件表示连接成功
4. 开始单向通信（服务端 → 客户端）
```

### 2.2 SSE 事件格式

#### 2.2.1 事件类型

**服务端 → 客户端事件:**

| 事件名 | 说明 | 数据格式 |
|-------|------|----------|
| connected | 连接成功 | `{"user_id": 123}` |
| chat | 聊天消息推送 | 消息对象 |
| heartbeat | 心跳保活 | `{"timestamp": 1707600000}` |

#### 2.2.2 消息推送事件 (chat)

```json
{
  "message_id": 123,
  "conversation_id": 1,
  "sender_id": 2,
  "receiver_id": 1,
  "type": "text",
  "content": "Hello!",
  "created_at": 1707600000
}
```

#### 2.2.3 心跳事件 (heartbeat)

```json
{
  "timestamp": 1707600000
}
```

### 2.3 HTTP API (客户端 → 服务端)

客户端通过 HTTP POST 发送消息，而非通过 SSE：

#### POST /api/conversations/:id/messages
发送消息

**请求体:**
```json
{
  "type": "text",
  "content": "Hello!"
}
```

**响应 (200):**
```json
{
  "id": 123,
  "conversation_id": 1,
  "sender_id": 1,
  "receiver_id": 2,
  "type": "text",
  "content": "Hello!",
  "status": "sent",
  "created_at": 1707600000
}
```

### 2.4 内部接口 (Go)

```go
package sse

// Handler SSE 处理器
type Handler interface {
    // Subscribe 处理 SSE 订阅
    Subscribe(c *gin.Context)
}

// Broadcast 广播给指定用户
func Broadcast(userID int64, msgType string, data interface{})
```

## 3. 内部设计

### 3.1 模块结构

```
sse/
├── handler.go          # SSE 处理器
└── (无其他文件)
```

### 3.2 SSE 处理器设计

```go
type Handler struct{}

// 客户端连接存储
var clients = make(map[int64]chan *PushMessage)

type PushMessage struct {
    Type string      `json:"type"`
    Data interface{} `json:"data"`
}
```

### 3.3 连接生命周期

```
建立连接
    │
    ├─→ 验证 Token
    │       │
    │       ├─→ 成功: 发送 connected 事件
    │       │       ├─→ 创建消息通道
    │       │       ├─→ 保存到 clients map
    │       │       └─→ 进入推送循环
    │       │
    │       └─→ 失败: 关闭连接
    │
    └─→ 连接保持
            │
            ├─→ 每30秒发送 heartbeat
            ├─→ 有消息时推送 chat 事件
            └─→ 客户端断开: 清理连接
```

### 3.4 心跳机制

```go
const (
    HeartbeatInterval = 30 * time.Second  // 30秒发送一次心跳
)

// 服务端实现
// 1. 定期发送 heartbeat 事件
// 2. 客户端收到心跳表示连接正常
// 3. SSE 断开时浏览器自动重连
```

### 3.5 消息推送

```
消息发送
    │
    ├─→ 消息模块调用 Broadcast(userID, "chat", data)
    │
    ├─→ 查找用户的 SSE 通道
    │       │
    │       ├─→ 找到: 异步发送到通道
    │       │   └─→ 通道满: 丢弃消息
    │
    └─→ 未找到: 用户离线，消息存储为离线消息
```

### 3.6 在线状态

SSE 本身不维护在线状态，仅用于消息推送。

客户端通过 SSE 连接的成功建立来认为用户"在线"。

## 4. 协议细节

### 4.1 SSE 连接状态

```
Disconnected
    │
    ├─→ Connecting (建立 SSE 连接)
    │
    ├─→ Connected (收到 connected 事件)
    │       │
    │       └─→ Disconnected (连接断开)
    │
    └─→ Disconnected
```

### 4.2 消息发送流程

```
客户端发送消息
    │
    ├─→ HTTP POST /api/conversations/:id/messages
    │
    ├─→ 服务端处理请求
    │       │
    │       ├─→ 验证请求
    │       ├─→ 存储消息
    │       ├─→ 通过 SSE 推送给接收者
    │       └─→ 返回消息对象
    │
    └─→ 客户端通过 SSE 接收推送
```

### 4.3 重连机制 (浏览器原生)

```
SSE 断开
    │
    ├─→ 浏览器自动重连
    │
    ├─→ 携带相同 token 重新连接
    │
    └─→ 服务器发送心跳保持连接
```

## 5. 错误处理

### 5.1 错误码

| 错误码 | 说明 |
|--------|------|
| SSE_NOT_AUTHENTICATED | 未认证 |
| SSE_AUTH_FAILED | 认证失败 |
| SSE_INVALID_TOKEN | 无效的 Token |

### 5.2 HTTP 状态码映射

| 错误码 | HTTP 状态 |
|--------|----------|
| SSE_NOT_AUTHENTICATED | 401 |
| SSE_AUTH_FAILED | 401 |
| SSE_INVALID_TOKEN | 401 |

## 6. 性能考虑

### 6.1 资源限制

| 限制项 | 值 |
|--------|-----|
| 单用户最大连接数 | 3 (浏览器限制) |
| 总连接数 | 60 (20用户 × 3) |
| 消息队列大小 | 100/连接 |
| 写超时 | 10s |

### 6.2 优化策略

1. **通道缓冲**: 每连接 100 条消息缓冲
2. **连接复用**: 少量连接即可满足需求
3. **内存管理**: 限制消息队列大小
4. **心跳保活**: 30秒心跳防止超时

## 7. 安全考虑

1. **认证必须**: 所有连接需要有效 Token
2. **Token 验证**: 验证 Token 有效性
3. **消息大小限制**: 通过 HTTP API 限制
4. **CORS 配置**: 允许跨域访问

## 8. 与 WebSocket 方案对比

| 特性 | WebSocket | SSE |
|------|-----------|-----|
| 通信方向 | 双向 | 单向（服务端→客户端） |
| 浏览器支持 | 需要 API | 原生支持 |
| 二进制支持 | 支持 | 仅文本 |
| 自动重连 | 需要手动实现 | 浏览器自动 |
| 连接开销 | 较大 | 较小 |
| 防火墙 | 可能被拦截 | 类似 HTTP |
| 复杂度 | 较高 | 较低 |

对于本系统（小团队 IM，支持10秒延迟）：
- **推荐 SSE**: 简单可靠，满足需求
- **客户端→服务端**: 使用 HTTP POST
- **服务端→客户端**: 使用 SSE 推送

## 9. 测试要点

- [ ] 连接建立和断开
- [ ] 认证成功/失败
- [ ] 心跳保活
- [ ] 消息推送
- [ ] 自动重连
- [ ] 多设备同时在线
- [ ] 消息发送 (HTTP API)
