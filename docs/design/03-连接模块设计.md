# 连接模块设计

## 1. 模块概述

### 1.1 职责
- WebSocket连接管理
- 连接认证
- 心跳保活
- 消息路由
- 离线消息推送
- 在线状态管理

### 1.2 依赖
- 用户模块 (认证)
- 消息模块 (离线消息)

### 1.3 被依赖
- 客户端连接模块

## 2. 对外接口

### 2.1 WebSocket端点

#### WS(S) /ws
WebSocket连接端点

**连接URL:**
```
ws://localhost:8443/ws
wss://localhost:8443/ws
```

**连接流程:**
```
1. 客户端建立WebSocket连接
2. 客户端发送认证消息 (MsgAuth)
3. 服务端验证Token
4. 返回认证结果
5. 开始双向通信
```

### 2.2 消息格式 (MessagePack)

#### 2.2.1 通用消息结构

```go
// WebSocket消息
type WSMessage struct {
    Type    MessageType `msgpack:"type"`     // 消息类型
    Seq     int64       `msgpack:"seq"`      // 序列号 (客户端生成)
    Payload []byte      `msgpack:"payload"`  // 消息负载 (MessagePack编码)
}
```

#### 2.2.2 消息类型

```go
type MessageType int16

// 客户端 → 服务端
const (
    MsgAuth        MessageType = 1   // 认证
    MsgChat        MessageType = 2   // 聊天消息
    MsgAck         MessageType = 3   // 确认
    MsgSyncReq     MessageType = 4   // 同步请求
    MsgPresence    MessageType = 5   // 在线状态
    MsgPing        MessageType = 6   // 心跳
)

// 服务端 → 客户端
const (
    MsgAuthRsp     MessageType = 101 // 认证响应
    MsgChatPush    MessageType = 102 // 消息推送
    MsgSyncRsp     MessageType = 103 // 同步响应
    MsgPresencePush MessageType = 104 // 在线状态推送
    MsgPong        MessageType = 105 // 心跳响应
    MsgError       MessageType = 106 // 错误通知
)
```

#### 2.2.3 消息负载结构

**认证请求 (MsgAuth):**
```go
type AuthPayload struct {
    Token string `msgpack:"token"`
}
```

**认证响应 (MsgAuthRsp):**
```go
type AuthResponsePayload struct {
    Success bool   `msgpack:"success"`
    UserID  int64  `msgpack:"user_id,omitempty"`
    Error   string `msgpack:"error,omitempty"`
}
```

**聊天消息 (MsgChat):**
```go
type ChatPayload struct {
    To       int64  `msgpack:"to"`        // 接收者ID
    Type     string `msgpack:"type"`      // text/voice/image
    Content  string `msgpack:"content"`   // 消息内容或媒体ID
}
```

**消息确认 (MsgAck):**
```go
type AckPayload struct {
    MessageID int64  `msgpack:"message_id"` // 消息ID
    Status    string `msgpack:"status"`     // delivered/read
}
```

**同步请求 (MsgSyncReq):**
```go
type SyncRequestPayload struct {
    LastMessageID int64  `msgpack:"last_message_id"` // 最后消息ID
    LastSyncTime  int64  `msgpack:"last_sync_time"`  // 最后同步时间
}
```

**同步响应 (MsgSyncRsp):**
```go
type SyncResponsePayload struct {
    Messages []Message `msgpack:"messages"` // 离线消息列表
    HasMore  bool      `msgpack:"has_more"` // 是否还有更多
}
```

**在线状态 (MsgPresence):**
```go
type PresencePayload struct {
    Status string `msgpack:"status"` // online/offline/away
}
```

**在线状态推送 (MsgPresencePush):**
```go
type PresencePushPayload struct {
    UserID int64  `msgpack:"user_id"`
    Status string `msgpack:"status"`
}
```

**错误通知 (MsgError):**
```go
type ErrorPayload struct {
    Code    string `msgpack:"code"`
    Message string `msgpack:"message"`
}
```

### 2.3 内部接口 (Go)

```go
package ws

// Connection WebSocket连接抽象
type Connection interface {
    ID() string
    UserID() int64
    Send(msg *WSMessage) error
    Close() error
}

// Manager 连接管理器接口
type Manager interface {
    // HandleConnection 处理新的WebSocket连接
    HandleConnection(conn *websocket.Conn)

    // GetConnection 获取用户的连接
    GetConnection(userID int64) Connection

    // GetConnections 获取用户的所有连接
    GetConnections(userID int64) []Connection

    // BroadcastToUser 向用户的所有连接发送消息
    BroadcastToUser(userID int64, msg *WSMessage) error

    // IsOnline 检查用户是否在线
    IsOnline(userID int64) bool

    // GetOnlineUsers 获取在线用户列表
    GetOnlineUsers() []int64

    // Disconnect 断开指定连接
    Disconnect(connID string)

    // DisconnectUser 断开用户的所有连接
    DisconnectUser(userID int64)
}

// MessageHandler 消息处理器接口
type MessageHandler interface {
    // HandleAuth 处理认证消息
    HandleAuth(conn Connection, payload *AuthPayload) error

    // HandleChat 处理聊天消息
    HandleChat(conn Connection, payload *ChatPayload) error

    // HandleAck 处理确认消息
    HandleAck(conn Connection, payload *AckPayload) error

    // HandleSync 处理同步请求
    HandleSync(conn Connection, payload *SyncRequestPayload) error

    // HandlePresence 处理在线状态
    HandlePresence(conn Connection, payload *PresencePayload) error

    // HandlePing 处理心跳
    HandlePing(conn Connection) error
}
```

## 3. 内部设计

### 3.1 模块结构

```
ws/
├── handler.go          # WebSocket处理器
├── manager.go          # 连接管理器
├── connection.go       # 连接封装
├── message.go          # 消息定义
├── codec.go            # MessagePack编解码
└── handler_*.go        # 各类消息处理器
```

### 3.2 连接管理器设计

```go
type ConnectionManager struct {
    connections map[string]*connection          // connID -> connection
    userConns   map[int64]map[string]*connection // userID -> connIDs
    mu          sync.RWMutex

    authMgr     auth.Manager
    msgHandler  MessageHandler
}

type connection struct {
    id     string
    userID int64
    conn   *websocket.Conn
    send   chan *WSMessage
    mgr    *ConnectionManager
}
```

### 3.3 连接生命周期

```
建立连接
    │
    ├─→ 创建connection对象
    │
    ├─→ 启动read goroutine (接收消息)
    │
    ├─→ 启动write goroutine (发送消息)
    │
    └─→ 等待认证消息
            │
            ├─→ 认证成功
            │       │
            │       ├─→ 设置userID
            │       ├─→ 添加到连接管理器
            │       ├─→ 发送离线消息
            │       └─→ 通知在线状态
            │
            └─→ 认证失败
                    │
                    └─→ 关闭连接
```

### 3.4 心跳机制

```go
const (
    PingInterval = 30 * time.Second  // 30秒发送一次ping
    PongTimeout  = 60 * time.Second  // 60秒没收到pong就断开
)

// 客户端实现
// 1. 定期发送MsgPing
// 2. 收到MsgPong重置超时计时器
// 3. 超时断开重连

// 服务端实现
// 1. 收到MsgPing立即回复MsgPong
// 2. 连接超时断开
```

### 3.5 消息路由

```
收到消息
    │
    ├─→ 解析消息类型
    │
    ├─→ 路由到对应处理器
    │       │
    │       ├─→ MsgAuth → HandleAuth
    │       ├─→ MsgChat → HandleChat → 转发到接收者
    │       ├─→ MsgAck → HandleAck → 更新消息状态
    │       ├─→ MsgSyncReq → HandleSync → 返回离线消息
    │       ├─→ MsgPresence → HandlePresence → 广播状态
    │       └─→ MsgPing → HandlePong
    │
    └─→ 处理失败 → 返回错误消息
```

### 3.6 离线消息处理

```
用户上线
    │
    ├─→ 连接认证成功
    │
    ├─→ 查询离线消息
    │       │
    │       ├─→ 获取未发送的消息
    │       ├─→ 批量推送给客户端
    │       └─→ 更新消息状态为delivered
    │
    └─→ 客户端确认接收
            │
            └─→ 更新消息状态
```

### 3.7 在线状态广播

```
用户状态变更
    │
    ├─→ 更新内存状态
    │
    ├─→ 通知其他在线用户
    │       │
    │       ├─→ 获取用户的所有连接
    │       ├─→ 发送MsgPresencePush
    │       └─→ 对方更新UI显示
    │
    └─→ 持久化状态到数据库 (可选)
```

## 4. 协议细节

### 4.1 连接状态机

```
Disconnected
    │
    ├─→ Connecting (建立WebSocket连接)
    │
    ├─→ Authenticating (发送认证消息)
    │       │
    │       ├─→ Authenticated (认证成功)
    │       │       │
    │       │       ├─→ Active (正常通信)
    │       │       │
    │       │       └─→ Disconnected (断开)
    │       │
    │       └─→ Disconnected (认证失败)
    │
    └─→ Disconnected
```

### 4.2 消息确认机制

```
发送消息
    │
    ├─→ 服务端存储消息
    │
    ├─→ 如果接收者在线
    │       │
    │       ├─→ 推送消息 → 接收者
    │       │
    │       └─→ 接收者返回Ack
    │               │
    │               └─→ 更新消息状态为delivered
    │
    └─→ 如果接收者离线
            │
            └─→ 标记为离线消息, 等待用户上线推送
```

### 4.3 重连机制 (客户端)

```go
// 客户端重连策略
type ReconnectPolicy struct {
    InitialInterval time.Duration  // 初始间隔 1s
    MaxInterval     time.Duration  // 最大间隔 30s
    MaxAttempts     int            // 最大尝试次数 无限
    BackoffFactor   float64        // 退避因子 1.5
}

// 重连流程
1. 连接断开
2. 等待退避时间
3. 尝试重新连接
4. 如果成功, 发送认证消息
5. 如果失败, 增加退避时间, 重复步骤2
```

## 5. 错误处理

### 5.1 错误码

| 错误码 | 说明 |
|--------|------|
| WS_INVALID_MESSAGE | 无效的消息格式 |
| WS_NOT_AUTHENTICATED | 未认证 |
| WS_AUTH_FAILED | 认证失败 |
| WS_INVALID_PAYLOAD | 无效的消息负载 |
| WS_USER_NOT_FOUND | 用户不存在 |
| WS_RATE_LIMITED | 频率限制 |
| WS_INTERNAL_ERROR | 内部错误 |

### 5.2 错误消息格式

```go
type ErrorPayload struct {
    Code    string `msgpack:"code"`
    Message string `msgpack:"message"`
}
```

## 6. 性能考虑

### 6.1 资源限制

| 限制项 | 值 |
|--------|-----|
| 单用户最大连接数 | 3 |
| 总连接数 | 60 (20用户 × 3) |
| 消息队列大小 | 100/连接 |
| 读超时 | 60s |
| 写超时 | 10s |

### 6.2 优化策略

1. **消息批处理**: 多条离线消息批量发送
2. **连接复用**: 少量连接即可满足需求
3. **内存管理**: 限制消息队列大小
4. **优雅关闭**: 通知所有连接即将关闭

## 7. 安全考虑

1. **认证必须**: 所有消息需要先认证
2. **Origin验证**: 验证请求来源
3. **消息大小限制**: 单条消息最大1MB
4. **频率限制**: 防止消息轰炸
5. **连接数限制**: 单用户最多3个连接

## 8. 测试要点

- [ ] 连接建立和断开
- [ ] 认证成功/失败
- [ ] 心跳保活
- [ ] 消息收发
- [ ] 离线消息推送
- [ ] 在线状态广播
- [ ] 多设备同时在线
- [ ] 重连机制
- [ ] 消息确认
- [ ] 并发连接
