# 用户模块设计

## 1. 模块概述

### 1.1 职责
- 用户注册
- 用户登录
- 认证鉴权 (JWT)
- 用户信息管理
- 在线状态管理

### 1.2 依赖
- 数据访问层 (DAL)
- JWT工具包

### 1.3 被依赖
- 连接模块
- 消息模块
- 媒体模块

## 2. 对外接口

### 2.1 HTTP API

#### POST /api/auth/register
用户注册

**请求:**
```json
{
  "username": "string (3-20字符)",
  "password": "string (6-32字符)",
  "nickname": "string (可选, 默认=username)"
}
```

**响应 (200):**
```json
{
  "user": {
    "id": 1,
    "username": "alice",
    "nickname": "Alice",
    "avatar": null,
    "created_at": 1707600000
  },
  "token": "eyJhbGciOiJIUzI1NiIs..."
}
```

**错误响应:**
- 400: 参数错误
- 409: 用户名已存在

---

#### POST /api/auth/login
用户登录

**请求:**
```json
{
  "username": "string",
  "password": "string"
}
```

**响应 (200):**
```json
{
  "user": {
    "id": 1,
    "username": "alice",
    "nickname": "Alice",
    "avatar": null,
    "created_at": 1707600000
  },
  "token": "eyJhbGciOiJIUzI1NiIs..."
}
```

**错误响应:**
- 400: 参数错误
- 401: 用户名或密码错误

---

#### GET /api/users/me
获取当前用户信息

**请求头:**
```
Authorization: Bearer <token>
```

**响应 (200):**
```json
{
  "id": 1,
  "username": "alice",
  "nickname": "Alice",
  "avatar": "/api/media/42",
  "created_at": 1707600000
}
```

**错误响应:**
- 401: 未认证

---

#### GET /api/users
获取用户列表

**请求头:**
```
Authorization: Bearer <token>
```

**查询参数:**
- `search`: 搜索关键词 (可选)
- `limit`: 返回数量 (默认50, 最大50)

**响应 (200):**
```json
{
  "users": [
    {
      "id": 1,
      "username": "alice",
      "nickname": "Alice",
      "avatar": "/api/media/42",
      "online": true,
      "last_seen": 1707600000
    },
    {
      "id": 2,
      "username": "bob",
      "nickname": "Bob",
      "avatar": null,
      "online": false,
      "last_seen": 1707590000
    }
  ]
}
```

**错误响应:**
- 401: 未认证

---

#### GET /api/users/:id
获取指定用户信息

**请求头:**
```
Authorization: Bearer <token>
```

**响应 (200):**
```json
{
  "id": 2,
  "username": "bob",
  "nickname": "Bob",
  "avatar": null,
  "online": false,
  "last_seen": 1707590000
}
```

**错误响应:**
- 401: 未认证
- 404: 用户不存在

---

#### PUT /api/users/me
更新当前用户信息

**请求头:**
```
Authorization: Bearer <token>
```

**请求:**
```json
{
  "nickname": "string (可选)",
  "avatar": "number (媒体ID, 可选)"
}
```

**响应 (200):**
```json
{
  "id": 1,
  "username": "alice",
  "nickname": "New Nickname",
  "avatar": "/api/media/42",
  "created_at": 1707600000
}
```

**错误响应:**
- 401: 未认证
- 400: 参数错误

---

### 2.2 内部接口 (Go)

```go
package user

// User 用户实体
type User struct {
    ID         int64  `json:"id"`
    Username   string `json:"username"`
    PasswordHash string `json:"-"` // 不对外暴露
    Nickname   string `json:"nickname"`
    AvatarID   *int64 `json:"avatar_id"`
    CreatedAt  int64  `json:"created_at"`
    LastSeen   int64  `json:"last_seen"`
}

// RegisterRequest 注册请求
type RegisterRequest struct {
    Username string `json:"username" validate:"required,min=3,max=20"`
    Password string `json:"password" validate:"required,min=6,max=32"`
    Nickname string `json:"nickname" validate:"max=50"`
}

// LoginRequest 登录请求
type LoginRequest struct {
    Username string `json:"username" validate:"required"`
    Password string `json:"password" validate:"required"`
}

// UpdateRequest 更新请求
type UpdateRequest struct {
    Nickname *string `json:"nickname" validate:"omitempty,max=50"`
    AvatarID *int64  `json:"avatar_id"`
}

// AuthResponse 认证响应
type AuthResponse struct {
    User  *User  `json:"user"`
    Token string `json:"token"`
}

// Service 用户服务接口
type Service interface {
    // Register 用户注册
    Register(req *RegisterRequest) (*AuthResponse, error)

    // Login 用户登录
    Login(req *LoginRequest) (*AuthResponse, error)

    // GetUserByID 根据ID获取用户
    GetUserByID(id int64) (*User, error)

    // GetUserByUsername 根据用户名获取用户
    GetUserByUsername(username string) (*User, error)

    // GetUsers 获取用户列表
    GetUsers(search string, limit int) ([]*User, error)

    // UpdateUser 更新用户信息
    UpdateUser(id int64, req *UpdateRequest) (*User, error)

    // UpdateLastSeen 更新最后活跃时间
    UpdateLastSeen(id int64) error

    // SetOnlineStatus 设置在线状态 (由连接模块调用)
    SetOnlineStatus(id int64, online bool) error

    // IsOnline 检查用户是否在线
    IsOnline(id int64) bool

    // ValidateToken 验证Token, 返回用户ID
    ValidateToken(token string) (int64, error)
}
```

## 3. 内部设计

### 3.1 模块结构

```
user/
├── service.go          # 服务实现
├── handler.go          # HTTP处理器
├── validator.go        # 请求验证
└── errors.go           # 错误定义
```

### 3.2 核心流程

#### 注册流程
```
1. 验证请求参数
    │
2. 检查用户名是否已存在
    │
3. 哈希密码 (bcrypt, cost=10)
    │
4. 创建用户记录
    │
5. 生成JWT Token
    │
6. 返回用户信息和Token
```

#### 登录流程
```
1. 验证请求参数
    │
2. 根据用户名查询用户
    │
3. 验证密码 (bcrypt)
    │
4. 更新最后活跃时间
    │
5. 生成JWT Token
    │
6. 返回用户信息和Token
```

#### Token验证流程
```
1. 解析JWT Token
    │
2. 验证签名
    │
3. 检查过期时间
    │
4. 返回用户ID
```

### 3.3 JWT设计

```go
// JWT Claims
type Claims struct {
    UserID int64  `json:"user_id"`
    jwt.RegisteredClaims
}

// Token配置
const (
    TokenSecret     = "zmessage-secret-key" // 生产环境应从配置读取
    TokenExpiration = 7 * 24 * time.Hour    // 7天
)
```

### 3.4 在线状态管理

```go
// 在线状态由连接模块维护
// 用户模块提供查询接口和状态变更通知

type OnlineStatusManager struct {
    onlineUsers map[int64]bool  // 在线用户集合
    mu          sync.RWMutex
}

func (m *OnlineStatusManager) SetOnline(userID int64, online bool)
func (m *OnlineStatusManager) IsOnline(userID int64) bool
func (m *OnlineStatusManager) GetOnlineUsers() []int64
```

## 4. 数据模型

### 4.1 数据库表

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    nickname TEXT NOT NULL,
    avatar_id INTEGER,
    created_at INTEGER NOT NULL,
    last_seen INTEGER NOT NULL,
    FOREIGN KEY (avatar_id) REFERENCES media(id)
);

CREATE INDEX idx_users_username ON users(username);
```

### 4.2 DAL接口

```go
package dal

type UserDAL interface {
    Create(user *User) error
    GetByID(id int64) (*User, error)
    GetByUsername(username string) (*User, error)
    List(search string, limit int) ([]*User, error)
    Update(user *User) error
    UpdateLastSeen(id int64, lastSeen int64) error
    Delete(id int64) error
}
```

## 5. 错误处理

### 5.1 错误码

| 错误码 | 说明 |
|--------|------|
| USER_INVALID_USERNAME | 用户名格式无效 |
| USER_INVALID_PASSWORD | 密码格式无效 |
| USER_ALREADY_EXISTS | 用户名已存在 |
| USER_NOT_FOUND | 用户不存在 |
| USER_INVALID_PASSWORD | 密码错误 |
| USER_INVALID_TOKEN | Token无效或过期 |
| USER_UNAUTHORIZED | 未认证 |

### 5.2 HTTP状态码映射

| 错误码 | HTTP状态 |
|--------|----------|
| USER_INVALID_* | 400 |
| USER_ALREADY_EXISTS | 409 |
| USER_NOT_FOUND | 404 |
| USER_INVALID_PASSWORD | 401 |
| USER_INVALID_TOKEN | 401 |
| USER_UNAUTHORIZED | 401 |

## 6. 安全考虑

1. **密码安全**
   - 使用bcrypt哈希 (cost=10)
   - 不存储明文密码
   - 不在日志中记录密码

2. **Token安全**
   - 使用HS256签名
   - 设置过期时间 (7天)
   - 生产环境使用环境变量配置密钥

3. **输入验证**
   - 用户名: 3-20字符, 字母数字下划线
   - 密码: 6-32字符
   - 昵称: 最多50字符

4. **防暴力破解**
   - 登录失败延迟 (指数退避)
   - 可选: IP限流

## 7. 测试要点

- [ ] 注册正常流程
- [ ] 注册重复用户名
- [ ] 注册参数验证 (用户名、密码格式)
- [ ] 登录正常流程
- [ ] 登录错误密码
- [ ] 登录不存在的用户
- [ ] Token验证 (有效、过期、无效)
- [ ] 获取用户列表 (搜索、分页)
- [ ] 更新用户信息
- [ ] 在线状态查询
