# 消息模块设计

## 1. 模块概述

### 1.1 职责
- 消息存储
- 消息转发
- 消息同步
- 消息状态管理
- 会话管理

### 1.2 依赖
- 数据访问层 (DAL)
- 连接模块 (推送消息)
- 用户模块 (用户信息)

### 1.3 被依赖
- 连接模块
- 客户端消息模块

## 2. 对外接口

### 2.1 HTTP API

#### GET /api/conversations
获取会话列表

**请求头:**
```
Authorization: Bearer <token>
```

**查询参数:**
- `page`: 页码 (默认1)
- `limit`: 每页数量 (默认20)

**响应 (200):**
```json
{
  "conversations": [
    {
      "id": 1,
      "participant": {
        "id": 2,
        "username": "bob",
        "nickname": "Bob",
        "avatar": null
      },
      "last_message": {
        "id": 123,
        "type": "text",
        "content": "Hello!",
        "sender_id": 2,
        "created_at": 1707600000
      },
      "unread_count": 3,
      "updated_at": 1707600000
    }
  ],
  "total": 10
}
```

**错误响应:**
- 401: 未认证

---

#### GET /api/conversations/:id
获取会话详情

**请求头:**
```
Authorization: Bearer <token>
```

**响应 (200):**
```json
{
  "id": 1,
  "participant": {
    "id": 2,
    "username": "bob",
    "nickname": "Bob",
    "avatar": null
  },
  "created_at": 1707500000,
  "updated_at": 1707600000
}
```

**错误响应:**
- 401: 未认证
- 403: 无权访问
- 404: 会话不存在

---

#### GET /api/conversations/:id/messages
获取会话消息历史

**请求头:**
```
Authorization: Bearer <token>
```

**查询参数:**
- `before_id`: 获取此ID之前的消息 (可选)
- `limit`: 返回数量 (默认50, 最大100)

**响应 (200):**
```json
{
  "messages": [
    {
      "id": 120,
      "conversation_id": 1,
      "sender_id": 2,
      "receiver_id": 1,
      "type": "text",
      "content": "Hi there!",
      "status": "read",
      "created_at": 1707599000
    },
    {
      "id": 121,
      "conversation_id": 1,
      "sender_id": 1,
      "receiver_id": 2,
      "type": "text",
      "content": "Hello!",
      "status": "delivered",
      "created_at": 1707600000
    }
  ],
  "has_more": true
}
```

**错误响应:**
- 401: 未认证
- 403: 无权访问
- 404: 会话不存在

---

#### POST /api/conversations/:id/read
标记会话消息为已读

**请求头:**
```
Authorization: Bearer <token>
```

**响应 (200):**
```json
{
  "success": true
}
```

**错误响应:**
- 401: 未认证
- 403: 无权访问
- 404: 会话不存在

---

#### GET /api/conversations/with/:user_id
获取与指定用户的会话

**请求头:**
```
Authorization: Bearer <token>
```

**响应 (200):**
```json
{
  "id": 1,
  "participant": {
    "id": 2,
    "username": "bob",
    "nickname": "Bob",
    "avatar": null
  },
  "created_at": 1707500000,
  "updated_at": 1707600000
}
```

**错误响应:**
- 401: 未认证
- 404: 用户不存在

---

### 2.2 内部接口 (Go)

```go
package message

// Message 消息实体
type Message struct {
    ID             int64  `json:"id"`
    ConversationID int64  `json:"conversation_id"`
    SenderID       int64  `json:"sender_id"`
    ReceiverID     int64  `json:"receiver_id"`
    Type           string `json:"type"`           // text/voice/image
    Content        string `json:"content"`        // 文本内容或媒体ID
    Status         string `json:"status"`         // sent/delivered/read
    CreatedAt      int64  `json:"created_at"`
    SyncedAt       *int64 `json:"synced_at,omitempty"`
}

// Conversation 会话实体
type Conversation struct {
    ID          int64      `json:"id"`
    UserAID     int64      `json:"user_a_id"`
    UserBID     int64      `json:"user_b_id"`
    CreatedAt   int64      `json:"created_at"`
    UpdatedAt   int64      `json:"updated_at"`
}

// ConversationWithInfo 带信息的会话
type ConversationWithInfo struct {
    ID           int64       `json:"id"`
    Participant  *UserInfo   `json:"participant"`
    LastMessage  *Message    `json:"last_message,omitempty"`
    UnreadCount  int         `json:"unread_count"`
    CreatedAt    int64       `json:"created_at"`
    UpdatedAt    int64       `json:"updated_at"`
}

// SendMessageRequest 发送消息请求 (内部, 由连接模块调用)
type SendMessageRequest struct {
    From     int64  `json:"from"`
    To       int64  `json:"to"`
    Type     string `json:"type"`
    Content  string `json:"content"`
}

// Service 消息服务接口
type Service interface {
    // SendMessage 发送消息 (由连接模块调用)
    SendMessage(req *SendMessageRequest) (*Message, error)

    // GetConversation 获取会话
    GetConversation(id int64, userID int64) (*ConversationWithInfo, error)

    // GetConversationWithUser 获取与指定用户的会话 (如不存在则创建)
    GetConversationWithUser(userID, otherUserID int64) (*ConversationWithInfo, error)

    // GetConversations 获取会话列表
    GetConversations(userID int64, page, limit int) ([]*ConversationWithInfo, int, error)

    // GetMessages 获取消息历史
    GetMessages(conversationID int64, userID int64, beforeID int64, limit int) ([]*Message, bool, error)

    // MarkAsRead 标记会话消息为已读
    MarkAsRead(conversationID int64, userID int64) error

    // UpdateMessageStatus 更新消息状态
    UpdateMessageStatus(messageID int64, status string) error

    // GetOfflineMessages 获取离线消息
    GetOfflineMessages(userID int64, lastMessageID int64, limit int) ([]*Message, error)

    // GetUnreadCount 获取未读消息数
    GetUnreadCount(conversationID int64, userID int64) (int, error)
}
```

## 3. 内部设计

### 3.1 模块结构

```
message/
├── service.go          # 服务实现
├── handler.go          # HTTP处理器
├── sync.go             # 同步逻辑
└── errors.go           # 错误定义
```

### 3.2 核心流程

#### 发送消息流程
```
1. 连接模块收到发送请求
    │
2. 调用消息模块SendMessage
    │
3. 验证发送者和接收者存在
    │
4. 获取或创建会话
    │
5. 存储消息到数据库
    │
6. 检查接收者是否在线
    │   ├─→ 在线: 通过连接模块推送
    │   └─→ 离线: 标记为离线消息
    │
7. 更新会话的updated_at
    │
8. 返回消息对象
```

#### 消息同步流程
```
客户端上线
    │
1. 连接模块认证成功
    │
2. 调用GetOfflineMessages
    │   │
    │   ├─→ 查询该用户的未发送消息
    │   └─→ 按时间排序返回
    │
3. 连接模块批量推送给客户端
    │
4. 客户端返回Ack确认
    │
5. 更新消息状态为delivered
```

#### 消息状态流转
```
sent (消息已发送到服务端)
    │
    ├─→ delivered (消息已投递到接收设备)
    │       │
    │       └─→ read (消息已读)
    │
    └─→ failed (发送失败, 仅限内部)
```

### 3.3 会话管理

```go
// 会话确定逻辑
func getOrCreateConversation(userA, userB int64) (*Conversation, error) {
    // 确保 userA < userB 保证唯一性
    if userA > userB {
        userA, userB = userB, userA
    }

    // 查询已有会话
    conv, err := dal.GetConversation(userA, userB)
    if err == nil {
        return conv, nil
    }

    // 创建新会话
    return dal.CreateConversation(userA, userB)
}
```

### 3.4 未读消息统计

```go
// 未读消息计数规则
// 1. 消息的receiver_id = 当前用户ID
// 2. 消息状态 != 'read'
// 3. 按会话分组统计

func (s *service) GetUnreadCount(convID, userID int64) (int, error) {
    return dal.CountUnreadMessages(convID, userID)
}
```

## 4. 数据模型

### 4.1 数据库表

```sql
-- 会话表
CREATE TABLE conversations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_a_id INTEGER NOT NULL,
    user_b_id INTEGER NOT NULL,
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    FOREIGN KEY (user_a_id) REFERENCES users(id),
    FOREIGN KEY (user_b_id) REFERENCES users(id),
    UNIQUE(user_a_id, user_b_id)
);

-- 消息表
CREATE TABLE messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    conversation_id INTEGER NOT NULL,
    sender_id INTEGER NOT NULL,
    receiver_id INTEGER NOT NULL,
    type TEXT NOT NULL,  -- 'text', 'voice', 'image'
    content TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'sent',  -- 'sent', 'delivered', 'read'
    created_at INTEGER NOT NULL,
    synced_at INTEGER,
    FOREIGN KEY (conversation_id) REFERENCES conversations(id),
    FOREIGN KEY (sender_id) REFERENCES users(id),
    FOREIGN KEY (receiver_id) REFERENCES users(id)
);

-- 索引
CREATE INDEX idx_messages_conversation ON messages(conversation_id, created_at DESC);
CREATE INDEX idx_messages_receiver_status ON messages(receiver_id, status) WHERE status != 'read';
CREATE INDEX idx_conversations_users ON conversations(user_a_id, user_b_id);
CREATE INDEX idx_conversations_updated ON conversations(updated_at DESC);
```

### 4.2 DAL接口

```go
package dal

type MessageDAL interface {
    // 消息操作
    CreateMessage(msg *Message) error
    GetMessage(id int64) (*Message, error)
    GetMessagesByConversation(convID int64, beforeID int64, limit int) ([]*Message, error)
    UpdateMessageStatus(id int64, status string) error
    UpdateMessagesStatus(convID int64, receiverID int64, status string) error

    // 离线消息
    GetOfflineMessages(userID int64, lastID int64, limit int) ([]*Message, error)

    // 未读统计
    CountUnreadMessages(convID int64, userID int64) (int, error)
    CountTotalUnread(userID int64) (int, error)
}

type ConversationDAL interface {
    CreateConversation(conv *Conversation) error
    GetConversation(id int64) (*Conversation, error)
    GetConversationByUsers(userA, userB int64) (*Conversation, error)
    GetConversationsByUser(userID int64, page, limit int) ([]*Conversation, int, error)
    UpdateConversationTime(id int64, updatedAt int64) error
}
```

## 5. 错误处理

### 5.1 错误码

| 错误码 | 说明 |
|--------|------|
| MSG_INVALID_TYPE | 无效的消息类型 |
| MSG_INVALID_CONTENT | 无效的消息内容 |
| MSG_CONVERSATION_NOT_FOUND | 会话不存在 |
| MSG_USER_NOT_FOUND | 用户不存在 |
| MSG_SEND_TO_SELF | 不能给自己发消息 |
| MSG_NOT_FOUND | 消息不存在 |
| MSG_ACCESS_DENIED | 无权访问 |

### 5.2 HTTP状态码映射

| 错误码 | HTTP状态 |
|--------|----------|
| MSG_INVALID_* | 400 |
| MSG_CONVERSATION_NOT_FOUND | 404 |
| MSG_USER_NOT_FOUND | 404 |
| MSG_SEND_TO_SELF | 400 |
| MSG_ACCESS_DENIED | 403 |

## 6. 同步机制

### 6.1 增量同步

```go
// 客户端保存最后同步的消息ID
// 每次同步请求携带last_message_id
// 服务端返回ID大于last_message_id的消息

type SyncRequest struct {
    LastMessageID int64  // 最后收到的消息ID
    LastSyncTime  int64  // 最后同步时间 (备用)
}

type SyncResponse struct {
    Messages []Message
    HasMore  bool  // 是否还有更多消息
}
```

### 6.2 同步策略

```
客户端上线
    │
    ├─→ 方案1: 基于消息ID同步
    │       │
    │       ├─→ 客户端发送最后收到的消息ID
    │       ├─→ 服务端查询ID > lastID的消息
    │       └─→ 返回新消息列表
    │
    └─→ 方案2: 基于时间同步 (备用)
            │
            ├─→ 客户端发送最后同步时间
            ├─→ 服务端查询created_at > lastSyncTime的消息
            └─→ 返回新消息列表
```

## 7. 性能优化

### 7.1 分页策略

- 会话列表: 默认20条/页
- 消息历史: 默认50条/页, 最大100条
- 使用`before_id`游标分页, 便于实现"加载更多"

### 7.2 索引优化

```sql
-- 常用查询优化
-- 1. 会话列表 (按updated_at排序)
CREATE INDEX idx_conversations_updated ON conversations(updated_at DESC);

-- 2. 消息列表 (按created_at排序)
CREATE INDEX idx_messages_conversation ON messages(conversation_id, created_at DESC);

-- 3. 未读消息查询
CREATE INDEX idx_messages_receiver_status ON messages(receiver_id, status)
WHERE status != 'read';
```

### 7.3 缓存策略 (可选)

```go
// 缓存会话信息
type ConversationCache struct {
    cache map[int64]*ConversationWithInfo
    ttl   time.Duration
}

// 缓存用户未读数
type UnreadCache struct {
    cache map[int64]map[int64]int  // userID -> convID -> count
    ttl   time.Duration
}
```

## 8. 测试要点

- [ ] 发送文本消息
- [ ] 发送语音消息 (媒体ID)
- [ ] 发送图片消息 (媒体ID)
- [ ] 接收者在线实时推送
- [ ] 接收者离线消息存储
- [ ] 消息状态更新
- [ ] 会话自动创建
- [ ] 会话列表排序
- [ ] 消息历史分页
- [ ] 未读消息统计
- [ ] 标记已读
- [ ] 同步离线消息
- [ ] 不能给自己发消息
