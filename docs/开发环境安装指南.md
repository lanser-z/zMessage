# 开发环境安装指南

## 环境要求

### 必需环境

| 软件 | 版本要求 | 用途 |
|------|----------|------|
| Go | 1.21+ | 后端开发 |
| Git | 任意 | 版本控制 |

### 可选环境

| 软件 | 用途 |
|------|------|
| curl/wget | 测试API |
| SQLite3 | 数据库调试 |

## 安装步骤

### 1. 检查系统信息

```bash
# 查看系统版本
cat /etc/os-release

# 查看架构
uname -m
```

### 2. 安装 Go

#### Ubuntu/Debian

```bash
# 下载 Go 1.23 (最新稳定版)
wget https://go.dev/dl/go1.23.5.linux-amd64.tar.gz

# 验证下载
sha256sum go1.23.5.linux-amd64.tar.gz

# 删除旧版本 (如果有)
sudo rm -rf /usr/local/go

# 解压到 /usr/local
sudo tar -C /usr/local -xzf go1.23.5.linux-amd64.tar.gz

# 配置环境变量 (添加到 ~/.bashrc 或 ~/.zshrc)
echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
echo 'export GOPATH=$HOME/go' >> ~/.bashrc
echo 'export PATH=$PATH:$GOPATH/bin' >> ~/.bashrc

# 重新加载配置
source ~/.bashrc

# 验证安装
go version
```

#### 验证 Go 安装

```bash
# 检查版本
go version

# 检查环境
go env

# 创建测试目录
mkdir -p ~/go/src/test
cd ~/go/src/test
cat > main.go << 'EOF'
package main
func main() {
    println("Hello, Go!")
}
EOF

# 运行测试
go run main.go
```

### 3. 安装 Git

#### Ubuntu/Debian

```bash
sudo apt update
sudo apt install git

# 验证安装
git --version
```

#### 配置 Git

```bash
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"
```

### 4. 安装项目级 Go 依赖 (项目初始化后执行)

```bash
# 进入项目目录
cd ~/aiprj/zMessage

# 初始化 Go 模块 (如果还没有)
go mod init zmessage

# 安装依赖 (在项目初始化后执行)
go get github.com/gin-gonic/gin
go get github.com/gorilla/websocket
go get github.com/vmihailenco/msgpack/v5
go get github.com/mattn/go-sqlite3
go get golang.org/x/crypto/bcrypt
go get github.com/go-playground/validator/v10

# 整理依赖
go mod tidy

# 验证依赖
go mod verify
```

### 5. (可选) 安装开发工具

```bash
# SQLite3 命令行工具
sudo apt install sqlite3

# curl 用于测试 API
sudo apt install curl

# jq 用于格式化 JSON
sudo apt install jq
```

### 6. 生成自签名 HTTPS 证书 (开发环境)

```bash
# 创建证书目录
mkdir -p ~/aiprj/zMessage/data/certs

# 生成自签名证书
openssl req -x509 -newkey rsa:4096 -keyout ~/aiprj/zMessage/data/certs/key.pem \
  -out ~/aiprj/zMessage/data/certs/cert.pem -days 365 -nodes \
  -subj "/C=CN/ST=Beijing/L=Beijing/O=zMessage/CN=localhost"

# 验证证书
openssl x509 -in ~/aiprj/zMessage/data/certs/cert.pem -text -noout
```

## 项目目录初始化

```bash
# 创建项目目录结构
cd ~/aiprj/zMessage

# 创建目录
mkdir -p server/{api/{handlers,routes},ws,modules/{user,message,conversation,media,sync},dal,models,pkg/{auth,msgpack,validator},config}
mkdir -p client/{assets/{css,js/{modules,store,protocol,utils}},data/{uploads/{original,thumbnail},certs}}
mkdir -p scripts

# 创建空文件占位 (后续开发时填充)
touch server/main.go
touch client/index.html
touch client/assets/css/style.css
touch client/assets/js/main.js
touch scripts/build.sh
chmod +x scripts/build.sh

# 创建数据目录
mkdir -p data/uploads/original
mkdir -p data/uploads/thumbnail
mkdir -p data/certs

# 验证目录结构
tree ~/aiprj/zMessage -L 3 -I 'node_modules'
```

## 环境验证

### 验证脚本

创建 `scripts/check-env.sh`:

```bash
#!/bin/bash

echo "=== 开发环境检查 ==="
echo ""

# 检查 Go
echo -n "Go: "
if command -v go &> /dev/null; then
    go version
else
    echo "未安装"
fi

# 检查 Git
echo -n "Git: "
if command -v git &> /dev/null; then
    git --version
else
    echo "未安装"
fi

# 检查 SQLite3
echo -n "SQLite3: "
if command -v sqlite3 &> /dev/null; then
    sqlite3 --version
else
    echo "未安装 (可选)"
fi

# 检查 curl
echo -n "curl: "
if command -v curl &> /dev/null; then
    curl --version | head -1
else
    echo "未安装 (可选)"
fi

# 检查项目目录
echo ""
echo "=== 项目目录检查 ==="
if [ -d "~/aiprj/zMessage" ]; then
    echo "项目目录存在"
    ls -la ~/aiprj/zMessage
else
    echo "项目目录不存在"
fi

# 检查 Go 模块
echo ""
echo "=== Go 模块检查 ==="
if [ -f "~/aiprj/zMessage/go.mod" ]; then
    echo "go.mod 已存在"
    cat ~/aiprj/zMessage/go.mod
else
    echo "go.mod 不存在, 需要初始化"
fi
```

### 运行验证

```bash
chmod +x scripts/check-env.sh
./scripts/check-env.sh
```

## 常见问题

### Go 版本过低

```bash
# 查看当前版本
go version

# 如果版本低于 1.21, 重新安装
sudo rm -rf /usr/local/go
wget https://go.dev/dl/go1.23.5.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.23.5.linux-amd64.tar.gz
```

### 代理设置 (国内用户)

```bash
# 设置 Go 代理
go env -w GOPROXY=https://goproxy.cn,direct
go env -w GOSUMDB=off

# 验证
go env GOPROXY
```

### 权限问题

```bash
# 确保 data 目录有写权限
chmod -R 755 ~/aiprj/zMessage/data
```

## 下一步

完成环境安装后:

1. 初始化 Go 模块: `go mod init zmessage`
2. 安装项目依赖: `go mod tidy`
3. 开始开发第一个模块

## 安装检查清单

- [ ] Go 1.21+ 已安装并验证
- [ ] Git 已安装
- [ ] Go 代理已配置 (国内用户)
- [ ] 项目目录结构已创建
- [ ] 自签名证书已生成
- [ ] 环境验证脚本通过
